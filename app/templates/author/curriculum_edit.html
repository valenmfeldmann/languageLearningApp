{% extends "base.html" %}
{% block title %}Edit Curriculum{% endblock %}

{% block content %}
  <style>
    @keyframes border-glow {
      0% { box-shadow: 0 0 5px rgba(168, 199, 255, 0.2); border-color: rgba(168, 199, 255, 0.1); }
      50% { box-shadow: 0 0 20px rgba(168, 199, 255, 0.4); border-color: rgba(168, 199, 255, 0.5); }
      100% { box-shadow: 0 0 5px rgba(168, 199, 255, 0.2); border-color: rgba(168, 199, 255, 0.1); }
    }
    .glow-container { animation: border-glow 4s infinite ease-in-out; border: 1px solid rgba(168, 199, 255, 0.1); border-radius: 12px; background: rgba(16, 20, 32, 0.4); }
    .item-row { cursor: default; border-bottom: 1px solid #222; }
    .drag-handle { cursor: grab !important; user-select: none; color: var(--muted); padding: 10px; text-align: center; width: 40px; }
    .drag-handle:active { cursor: grabbing !important; }
    .item-row:hover { background: rgba(255,255,255,0.02); }


    body.drag-over-active {
        outline: 4px dashed var(--primary);
        outline-offset: -4px;
        background-color: rgba(var(--primary-rgb), 0.05);
    }

  </style>

  <div style="display:flex; align-items: baseline; justify-content: space-between; margin-bottom: 20px;">
    <button type="button" onclick="window.location.href='{{ url_for('main.curriculum_view', curriculum_code=curriculum.code) }}'">&larr; Back to view</button>
    <h1 style="margin:0;">Edit: {{ curriculum.title }}</h1>
    <form method="POST" action="{{ url_for('author.curriculum_archive', curriculum_id=curriculum.id) if not curriculum.is_archived else url_for('author.curriculum_unarchive', curriculum_id=curriculum.id) }}">
        <button type="submit" style="{{ 'background:#7a1e1e;' if not curriculum.is_archived else '' }}">{{ 'Archive' if not curriculum.is_archived else 'Unarchive' }}</button>
    </form>
  </div>

  <form method="POST" enctype="multipart/form-data" action="{{ url_for('author.curriculum_edit_post', curriculum_id=curriculum.id) }}">
    <div style="max-width:1100px; border:1px solid rgba(255,255,255,0.18); border-radius:14px; padding:14px; margin-bottom:16px; background: {% if curriculum.is_published %}rgba(0, 200, 0, 0.10){% else %}rgba(255, 80, 80, 0.10){% endif %}; display:flex; justify-content:space-between; align-items:center;">
      <div style="font-weight:800;">{% if curriculum.is_published %}‚úÖ Published{% else %}üö´ Not published{% endif %}</div>
      <button type="submit"
              name="publish_action"
              value="{{ 'unpublish' if curriculum.is_published else 'publish' }}"
              onclick="this.form.submitted_by = this;"> {{ 'Unpublish' if curriculum.is_published else 'Publish' }}
      </button>
    </div>

    <details class="panel" style="margin-bottom: 30px; border: 1px solid rgba(168,199,255,0.1); border-radius: 12px; cursor: pointer;">
        <summary style="padding: 16px 20px; color: var(--link); font-weight: bold;">General Settings</summary>
        <div style="padding: 20px; cursor: default;">
            <label class="muted">Title</label>
            <input type="text" name="title_meta" value="{{ curriculum.title }}" style="width: 100%; padding: 12px; background: #000; border: 1px solid #333; border-radius: 8px;">
            <label class="muted" style="margin-top:15px; display:block;">Description</label>
            <textarea name="description_meta" rows="3" style="width: 100%; padding: 12px; background: #000; border: 1px solid #333; border-radius: 8px;">{{ curriculum.description }}</textarea>
        </div>
    </details>


    <datalist id="lesson-datalist">
      {% for L in lessons %}
        <option value="{{ L.title|e }}"></option>
      {% endfor %}
    </datalist>


    <div class="panel" style="padding: 25px; border: 1px solid rgba(168,199,255,0.2); background: rgba(16,20,32,0.6);">
      <h2 style="color: var(--link); margin-bottom:20px;">Curriculum Builder</h2>
      <div class="glow-container" style="padding: 20px; margin-bottom: 20px;">
        <table style="width: 100%; border-collapse: collapse;">
          <thead>
            <tr style="text-align: left; color: var(--muted); font-size: 0.85rem; text-transform: uppercase;">
              <th style="width: 40px;"></th>
              <th style="padding: 15px; width: 120px;">Type</th>
              <th style="padding: 15px;">Phase title</th>
              <th style="padding: 15px; width: 350px;">Lesson (Search)</th>
              <th style="padding: 15px; width: 90px; text-align:center;">Repeat</th>
              <th style="padding: 15px; width: 60px; text-align:center;">Del</th>
            </tr>
          </thead>
          <tbody id="items-body">
            {% for it in items %}



              <tr class="item-row">
                <td class="drag-handle">‚ò∞</td>
                <td>
                  <select name="item_type" class="item-type" onchange="syncRow(this)" style="width: 100%; padding: 8px;">
                    <option value="phase" {% if it.item_type == "phase" %}selected{% endif %}>phase</option>
                    <option value="lesson" {% if it.item_type == "lesson" %}selected{% endif %}>lesson</option>
                  </select>
                </td>
                <td><input type="text" name="phase_title" class="phase-title" value="{{ it.phase_title or '' }}" placeholder="Phase name" style="width: 100%; padding: 8px;"></td>


                <td style="padding: 10px;">
                  <div class="lesson-wrap">
                    <input type="text"
                           class="lesson-search-input"
                           list="lesson-datalist"
                           placeholder="Search lessons..."
                           oninput="filterLessonSearch(this)"
                           onchange="filterLessonSearch(this)"
                           value="{% for L in lessons %}{% if it.lesson_id == L.id %}{{ L.title }}{% endif %}{% endfor %}"
                           style="width: 100%; padding: 8px; background: #000; color: var(--link); border: 1px solid #444;">


                    <select name="lesson_id" class="lesson-id" style="display:none;">
                      <option value="">-- none --</option>
                      {% for L in lessons %}
                        <option value="{{ L.id }}" {% if it.lesson_id == L.id %}selected{% endif %}>{{ L.title }}</option>
                      {% endfor %}
                    </select>
                  </div>
                </td>


                <td><input type="number" name="repeat" class="repeat" value="{{ it.repeat or 1 }}" min="1" max="50" style="width: 100%; padding: 8px; text-align:center;"></td>

                <td style="text-align:center;">
                  <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
                    <button type="button" onclick="removeRow(this)" title="Remove from Curriculum" style="color: var(--muted); background:none; border:none; font-size: 1.2rem;">‚úï</button>

                    {% if it.item_type == 'lesson' and it.lesson_id %}
                      <button type="button"
                              onclick="deleteSourceLesson('{{ it.lesson_id }}')"
                              title="Delete Lesson from Server"
                              style="color: var(--error); background:none; border:none; font-size: 0.6rem; text-transform: uppercase; font-weight: bold;">
                        Delete Source
                      </button>
                    {% endif %}
                  </div>
                </td>


              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div style="display: flex; gap: 10px;">
        <button type="button" onclick="addPhaseRow()">+ Add Phase</button>
        <button type="button" onclick="addLessonRow()">+ Add Lesson</button>
      </div>
    </div>

    <div style="display:flex; gap:16px; margin-top:30px;">
      <div id="coverDrop" style="width:260px; height:160px; border:1px dashed rgba(255,255,255,0.35); border-radius:12px; cursor:pointer; position:relative; display:flex; align-items:center; justify-content:center; background: rgba(255,255,255,0.04);">
        {% set has_cover = (curriculum.cover_image_url is not none and curriculum.cover_image_url|length > 0) %}
        <img id="coverPreview" src="{{ curriculum.cover_image_url if has_cover else '' }}" style="width:100%; height:100%; object-fit:cover; {{ 'display:block;' if has_cover else 'display:none;' }}">
        {% if not has_cover %}<div style="text-align:center; padding:12px; opacity:0.85;">Add cover image</div>{% endif %}
      </div>
      <div style="flex:1;">
        <input id="coverInput" type="file" name="cover_image" accept="image/*" style="display:none;">
        <button type="button" id="chooseCoverBtn">Choose image</button>
        {% if curriculum.cover_image_url %}
          <button type="submit" formaction="{{ url_for('author.curriculum_cover_remove', curriculum_id=curriculum.id) }}">Remove</button>
        {% endif %}
      </div>
    </div>

    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid #333;">
      <button type="submit" class="btn primary" style="padding: 12px 30px; font-weight: bold;">Save Changes</button>
    </div>
  </form>

  <details class="panel" style="margin-top: 30px; border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; cursor: pointer;">
    <summary style="padding:14px; font-weight:800;">Sharing & Permissions</summary>
    <div style="padding: 16px; cursor: default;">
      <form id="invite-editor-form" method="POST" action="{{ url_for('author.curriculum_editor_invite', curriculum_id=curriculum.id) }}" style="display:flex; gap:10px; margin-bottom:15px;">
        <input name="email" type="email" placeholder="friend@example.com" style="flex:1; padding:10px; border-radius:10px; background: #000; border: 1px solid #333;">
        <button type="submit">Grant edit access</button>
      </form>
      {% if editors %}{% for ed, u in editors %}
        <div style="display:flex; justify-content:space-between; padding:10px; border-radius:12px; background:rgba(255,255,255,0.04); margin-bottom:5px;">
          <div><div style="font-weight:700;">{{ u.email }}</div><div style="font-size:13px; opacity:0.8;">{{ '‚úÖ Can edit' if ed.can_edit else '‚è≥ Pending' }}</div></div>
          <form method="POST" action="{{ url_for('author.curriculum_editor_remove', curriculum_id=curriculum.id) }}">
            <input type="hidden" name="user_id" value="{{ u.id }}"><button type="submit" style="background:#7a1e1e;">Remove</button>
          </form>
        </div>
      {% endfor %}{% endif %}
    </div>
  </details>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>

  window.addEventListener("DOMContentLoaded", () => {
      const el = document.getElementById('items-body');
      // 1. Initialize Drag and Drop
      if (el) Sortable.create(el, { handle: '.drag-handle', animation: 150 });

      // 2. Prevent Enter key from submitting the form in search inputs
      document.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' && e.target.classList.contains('lesson-search-input')) {
              e.preventDefault(); // Stop the form submission
              e.target.blur();    // Finalize the input and trigger sync logic
          }
      });

      // 3. Check existing rows to set initial border colors
      document.querySelectorAll(".lesson-search-input").forEach(input => {
          if (input.value.trim() !== "") filterLessonSearch(input);
      });

      // 4. Initialize row visibility
      document.querySelectorAll("select.item-type").forEach(syncRow);
  });


  function removeRow(btn) { btn.closest("tr").remove(); }


  function syncRow(sel) {
    const tr = sel.closest("tr");
    if (!tr) return;
    const isPhase = sel.value === "phase";

    // Toggle visibility using display
    tr.querySelector(".phase-title").style.display = isPhase ? "block" : "none";
    tr.querySelector(".lesson-wrap").style.display = isPhase ? "none" : "block";
    tr.querySelector(".repeat").style.display = isPhase ? "none" : "block";

    // CRITICAL: If it's a phase, we must clear the lesson_id so the server doesn't
    // try to link a lesson to a phase header
    if (isPhase) {
      const hiddenSelect = tr.querySelector(".lesson-id");
      if (hiddenSelect) hiddenSelect.value = "";
      const searchInput = tr.querySelector(".lesson-search-input");
      if (searchInput) searchInput.value = "";
    }
  }

  function filterLessonSearch(input) {
    const val = input.value.trim(); // Trim whitespace for cleaner matching
    const tr = input.closest("tr");
    const select = tr.querySelector(".lesson-id");
    const options = select.options;

    let found = false;
    // Look for the ID corresponding to the exact title selected from the pop-up
    for (let i = 0; i < options.length; i++) {
      if (options[i].text === val && val !== "") {
        select.value = options[i].value;
        input.style.borderColor = "var(--link)"; // Success blue
        found = true;
        break;
      }
    }

    // If no match found yet, clear the hidden ID so the server doesn't save junk data
    if (!found) {
      select.value = "";
      input.style.borderColor = "#444"; // Reset to neutral border
    }
  }


  function lessonOptionsHtml() {
    return `{% for L in lessons %}<option value="{{ L.id }}">{{ L.title|e }}</option>{% endfor %}`;
  }

  function phaseRowHtml() {
    return `
      <tr class="item-row">
        <td class="drag-handle">‚ò∞</td>
        <td>
          <select name="item_type" class="item-type" onchange="syncRow(this)" style="width: 100%; padding: 8px;">
            <option value="phase" selected>phase</option>
            <option value="lesson">lesson</option>
          </select>
        </td>
        <td><input type="text" name="phase_title" class="phase-title" placeholder="Phase name" style="width: 100%; padding: 8px;"></td>
        <td>
          <div class="lesson-wrap">
            <input type="text" class="lesson-search-input" list="lesson-datalist" oninput="filterLessonSearch(this)" placeholder="Search..." style="width: 100%; padding: 8px;">
            <select name="lesson_id" class="lesson-id" style="display:none;">
              <option value="">-- none --</option>
              ${lessonOptionsHtml()}
            </select>
          </div>
        </td>
        <td><input type="number" name="repeat" class="repeat" value="1" style="width: 100%; padding: 8px; text-align:center;"></td>
        <td style="text-align:center;">
          <div style="display: flex; flex-direction: column; gap: 4px; align-items: center;">
            <button type="button" onclick="removeRow(this)" title="Remove from Curriculum" style="color: var(--muted); background:none; border:none; font-size: 1.2rem;">‚úï</button>
            </div>
        </td>
      </tr>`;
  }

  function addPhaseRow() { document.getElementById("items-body").insertAdjacentHTML("beforeend", phaseRowHtml()); syncRow(document.getElementById("items-body").lastElementChild.querySelector(".item-type")); }
  function addLessonRow() { addPhaseRow(); const last = document.getElementById("items-body").lastElementChild; last.querySelector(".item-type").value = "lesson"; syncRow(last.querySelector(".item-type")); }

  (function () {
    const drop = document.getElementById("coverDrop"), input = document.getElementById("coverInput"), preview = document.getElementById("coverPreview"), chooseBtn = document.getElementById("chooseCoverBtn");
    if (!drop || !input) return;
    const pick = () => input.click();
    chooseBtn.onclick = pick; drop.onclick = pick;
    input.onchange = () => { if (input.files[0]) preview.src = URL.createObjectURL(input.files[0]); preview.style.display = "block"; };
    drop.ondragover = (e) => { e.preventDefault(); drop.style.outline = "2px solid var(--link)"; };
    drop.ondrop = (e) => { e.preventDefault(); input.files = e.dataTransfer.files; input.onchange(); };
  })();


  /* curriculum_edit.html */
  function deleteSourceLesson(lessonId) {
      if (confirm("üö® WARNING: This will permanently delete this lesson and ALL its associated media (images/audio) from the server. This cannot be undone. Proceed?")) {
          const form = document.createElement('form');
          form.method = 'POST';
          form.action = `/author/lesson/${lessonId}/delete`;
          document.body.appendChild(form);
          form.submit();
      }
  }




  window.addEventListener('dragover', (e) => {
      e.preventDefault();
      document.body.classList.add('drag-active'); // Show an overlay if you want
  });

  window.addEventListener('drop', async (e) => {
      e.preventDefault();
      const files = Array.from(e.dataTransfer.files);

      // Check if it's a zip or if they dropped multiple files
      const lessonJson = files.find(f => f.name === 'lesson.json');
      const assetsZip = files.find(f => f.name.endsWith('.zip'));

      if (lessonJson) {
          const formData = new FormData();
          formData.append('lesson_json', lessonJson);
          if (assetsZip) formData.append('assets_zip', assetsZip);

          const resp = await fetch(`/author/curriculum/{{ curriculum.id }}/drop_import`, {
              method: 'POST',
              body: formData
          });

          if (resp.ok) {
              window.location.reload(); // Refresh to show the new row
          } else {
              const err = await resp.json();
              alert("Import failed: " + err.error);
          }
      }
  });





  // =========================================
  // Drag and Drop Lesson Import Implementation
  // =========================================
  const dropZone = document.body;

  // Prevent default browser behaviors for drag events
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
  }

  // Add/remove visual highlight when dragging over the window
  ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, highlight, false);
  });

  ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, unhighlight, false);
  });

  function highlight(e) {
      dropZone.classList.add('drag-over-active');
  }

  function unhighlight(e) {
      dropZone.classList.remove('drag-over-active');
  }

  // Handle the dropped files
  dropZone.addEventListener('drop', handleDrop, false);




  async function handleDrop(e) {
      const files = Array.from(e.dataTransfer.files);

      // EXIT EARLY if no files were dropped (e.g., just reordering rows)
      if (files.length === 0) {
          return;
      }

      const lessonJson = files.find(f => f.name === 'lesson.json');
      const masterZip = files.find(f => f.name.endsWith('.zip'));

      const formData = new FormData();
      let endpoint = "";

      if (masterZip && !lessonJson) {
          // SCENARIO 1: Master ZIP containing multiple lessons
          formData.append('master_zip', masterZip);
          endpoint = `/author/curriculum/{{ curriculum.id }}/batch_import`;
      } else if (lessonJson) {
          // SCENARIO 2: Single lesson (loose files)
          formData.append('lesson_json', lessonJson);
          files.filter(f => f.name !== 'lesson.json').forEach(f => {
              formData.append('asset_files', f);
          });
          endpoint = `/author/curriculum/{{ curriculum.id }}/drop_import`;
      } else {
          alert("Please drop either a master ZIP file or a selection of files including 'lesson.json'.");
          return;
      }

      try {
          document.body.style.cursor = 'wait';
          const resp = await fetch(endpoint, {
              method: 'POST',
              body: formData
          });

          if (resp.ok) {
              window.location.reload();
          } else {
              const err = await resp.json();
              alert("Import failed: " + err.error);
          }
      } catch (err) {
          alert("Upload error: " + err.message);
      } finally {
          document.body.style.cursor = 'default';
      }
  }

</script>
{% endblock %}
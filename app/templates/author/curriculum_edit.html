{% extends "base.html" %}
{% block title %}Edit Curriculum{% endblock %}

{% block content %}
  <div style="display:flex; align-items: baseline; gap: 12px;">
    <h1 style="margin:0;">Edit curriculum: {{ curriculum.title }}</h1>

    <div style="margin: 12px 0; display:flex; gap:12px; align-items:center;">
      {% if curriculum.is_archived %}
        <span style="padding:4px 10px; border-radius:999px; background:#333; font-size:13px;">
          Archived
        </span>

        <form method="POST"
              action="{{ url_for('author.curriculum_unarchive', curriculum_id=curriculum.id) }}">
          <button type="submit">
            Unarchive
          </button>
        </form>
      {% else %}
        <form method="POST"
              action="{{ url_for('author.curriculum_archive', curriculum_id=curriculum.id) }}"
              onsubmit="return confirm('Archive this curriculum? It will be hidden from users but not deleted.');">
          <button type="submit"
                  style="background:#7a1e1e; color:white; border:none; padding:6px 12px; border-radius:8px;">
            Archive curriculum
          </button>
        </form>
      {% endif %}
    </div>

    <a href="{{ url_for('main.curriculum_view', curriculum_code=curriculum.code) }}" style="font-size: 14px;">
      View
    </a>
  </div>


  {% if editors %}
    <hr>
    <h3>Editors</h3>

    {% if can_manage %}
      <form method="POST"
            action="{{ url_for('author.curriculum_editor_add', curriculum_code=curriculum.code) }}"
            style="display:flex; gap:8px; max-width:420px; margin-bottom:12px;">
        <input type="email"
               name="email"
               placeholder="Invite editor by email"
               required
               style="flex:1;">
        <button type="submit">Add</button>
      </form>
    {% endif %}

    <ul style="list-style:none; padding:0; margin:0;">
      {% for ed, u in editors %}
        <li style="display:flex; align-items:center; gap:10px; margin-bottom:6px;">
          <span>{{ u.email }}</span>
          <span style="font-size:12px; opacity:0.7;">
            {% if ed.can_edit %}(can edit){% else %}(view only){% endif %}
          </span>

          {% if can_manage %}
            <form method="POST"
                  action="{{ url_for('author.curriculum_editor_remove', curriculum_code=curriculum.code) }}"
                  style="margin-left:auto;">
              <input type="hidden" name="user_id" value="{{ u.id }}">
              <button type="submit">Remove</button>
            </form>
          {% endif %}
        </li>
      {% endfor %}
    </ul>
  {% endif %}



  <p style="opacity:0.75; margin-top: 8px;">
    Add phases and lessons. ‚ÄúRepeat‚Äù expands a lesson into multiple slots.
  </p>

  <form method="POST"
        enctype="multipart/form-data"
        action="{{ url_for('author.curriculum_edit_post', curriculum_id=curriculum.id) }}">

    <!-- PUT PUBLISH BLOCK RIGHT HERE -->
    <div style="
      max-width:1100px;
      border:1px solid rgba(255,255,255,0.18);
      border-radius:14px;
      padding:14px 16px;
      margin: 12px 0 16px 0;
      background: {% if curriculum.is_published %}rgba(0, 200, 0, 0.10){% else %}rgba(255, 80, 80, 0.10){% endif %};
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:14px;
    ">
      <div>
        <div style="font-weight:800; font-size:16px;">
          {% if curriculum.is_published %}
            ‚úÖ Published ‚Äî visible to everyone
          {% else %}
            üö´ Not published ‚Äî nobody will see this in Explore
          {% endif %}
        </div>
        <div style="opacity:0.8; font-size:13px; margin-top:4px;">
          Publishing controls visibility. Archiving is separate.
        </div>
      </div>

      {% if curriculum.is_published %}
        <button type="submit" name="publish_action" value="unpublish"
                style="padding:10px 14px; border-radius:12px; font-weight:800;
                       border:1px solid rgba(255,255,255,0.25);
                       background: rgba(255, 80, 80, 0.20); cursor:pointer;">
          Unpublish
        </button>
      {% else %}
        <button type="submit" name="publish_action" value="publish"
                style="padding:10px 14px; border-radius:12px; font-weight:900;
                       border:1px solid rgba(255,255,255,0.25);
                       background: rgba(0, 200, 0, 0.22); cursor:pointer;">
          Publish
        </button>
      {% endif %}
    </div>



    <div style="max-width:1100px; border:1px solid rgba(255,255,255,0.18);
                border-radius:14px; padding:14px 16px; margin: 12px 0 16px 0;">
      <div style="font-weight:800; margin-bottom:10px;">Sharing</div>

      <div style="opacity:0.8; font-size:13px; margin-bottom:10px;">
        Add an editor by email. Pending requests show up here too.
      </div>

      <form method="POST" action="{{ url_for('author.curriculum_editor_invite', curriculum_id=curriculum.id) }}"
            style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
        <input name="email" type="email" placeholder="friend@example.com"
               style="padding:10px 12px; border-radius:10px; min-width:280px;">
        <button type="submit" style="padding:10px 14px; border-radius:10px; font-weight:800;">
          Grant edit access
        </button>
      </form>

      {% if editors and editors|length > 0 %}
        <div style="margin-top:12px; display:flex; flex-direction:column; gap:8px;">
          {% for ed, u in editors %}
            <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;
                        padding:10px 12px; border-radius:12px; background:rgba(255,255,255,0.04);">
              <div>
                <div style="font-weight:700;">{{ u.email }}</div>
                <div style="font-size:13px; opacity:0.8;">
                  {% if ed.can_edit %}
                    ‚úÖ Can edit
                  {% else %}
                    ‚è≥ Requested access (pending)
                  {% endif %}
                </div>
              </div>

              <div style="display:flex; gap:8px; align-items:center;">
                {% if not ed.can_edit %}
                  <form method="POST" action="{{ url_for('author.curriculum_editor_approve', curriculum_id=curriculum.id) }}">
                    <input type="hidden" name="user_id" value="{{ u.id }}">
                    <button type="submit">Approve</button>
                  </form>
                {% endif %}

                <form method="POST" action="{{ url_for('author.curriculum_editor_remove', curriculum_id=curriculum.id) }}">
                  <input type="hidden" name="user_id" value="{{ u.id }}">
                  <button type="submit" style="background:#7a1e1e; color:white; border:none; padding:8px 10px; border-radius:10px;">
                    Remove
                  </button>
                </form>
              </div>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>






    <div style="margin: 10px 0;">
      <label for="lesson-filter" style="display:block; opacity:0.8;">Filter lesson dropdowns</label>
      <input id="lesson-filter" type="text" placeholder="Type to filter lessons‚Ä¶" style="width: 420px; max-width: 100%;">
    </div>

    <table border="1" cellpadding="8" cellspacing="0" style="width: 100%; max-width: 1100px;">
      <thead>
        <tr>
          <th style="width: 110px;">Type</th>
          <th>Phase title</th>
          <th style="width: 330px;">Lesson</th>
          <th style="width: 90px;">Repeat</th>
          <th>Note</th>
          <th style="width: 110px;">Row</th>
        </tr>
      </thead>

      <tbody id="items-body">
        {% for it in items %}
          <tr class="item-row">
            <td>
              <select name="item_type" class="item-type" onchange="syncRow(this)">
                <option value="phase" {% if it.item_type == "phase" %}selected{% endif %}>phase</option>
                <option value="lesson" {% if it.item_type == "lesson" %}selected{% endif %}>lesson</option>
              </select>
            </td>

            <td>
              <div class="phase-wrap">
                <input type="text" name="phase_title" class="phase-title"
                       value="{{ it.phase_title or '' }}"
                       placeholder="Phase name"
                       style="width: 100%;">
              </div>
            </td>

            <td>
              <div class="lesson-wrap">
                <select name="lesson_id" class="lesson-id" style="width: 100%;">
                  <option value="">-- choose lesson --</option>
                  {% for L in lessons %}
                    <option value="{{ L.id }}" {% if it.lesson_id == L.id %}selected{% endif %}>
                      {{ L.title }} ({{ L.code }})
                    </option>
                  {% endfor %}
                </select>
              </div>
            </td>

            <td style="text-align:center;">
              <div class="repeat-wrap">
                <input type="number" name="repeat" class="repeat"
                       value="1" min="1" max="50" style="width: 70px;">
              </div>
            </td>

            <td>
              <input type="text" name="note" class="note" value="{{ it.note or '' }}"
                     placeholder="Optional note" style="width: 100%;">
            </td>

            <td style="text-align:center;">
              <button type="button" onclick="removeRow(this)">Remove</button>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

    <div style="margin-top: 12px;">
      <button type="button" onclick="addPhaseRow()">+ Phase</button>
      <button type="button" onclick="addLessonRow()">+ Lesson</button>
    </div>

    <div style="margin-top: 14px;">
      <button type="submit">Save</button>
      <a href="{{ url_for('author.curriculum_new_form') }}" style="margin-left: 10px;">New curriculum</a>
      <a href="{{ url_for('author.import_form') }}" style="margin-left: 10px;">Import lesson</a>
    </div>


  <div style="display:flex; gap:16px; align-items:flex-start; margin:14px 0; max-width: 1100px;">
    <div id="coverDrop"
         style="width:260px; height:160px; border:1px dashed rgba(255,255,255,0.35);
                border-radius:12px; overflow:hidden; cursor:pointer; position:relative;
                display:flex; align-items:center; justify-content:center; background: rgba(255,255,255,0.04);">
      {% set has_cover = (curriculum.cover_image_url is not none and curriculum.cover_image_url|length > 0) %}

      <img id="coverPreview"
           src="{{ curriculum.cover_image_url if has_cover else '' }}"
           alt="Cover"
           style="width:100%; height:100%; object-fit:cover; {{ 'display:block;' if has_cover else 'display:none;' }}">

      {% if has_cover %}
        <div style="position:absolute; inset:0; background:rgba(0,0,0,0.25); opacity:0; transition:0.15s;"></div>
        <div style="position:absolute; bottom:8px; left:10px; right:10px; font-size:13px; opacity:0; transition:0.15s;">
          Click or drop to replace
        </div>
      {% else %}
        <div style="text-align:center; padding:12px; opacity:0.85;">
          <div style="font-weight:600;">Add cover image</div>
          <div style="font-size:13px; opacity:0.8; margin-top:6px;">Click or drag & drop</div>
          <div style="font-size:12px; opacity:0.6; margin-top:6px;">png/jpg/webp/gif</div>
        </div>
      {% endif %}
    </div>

    <div style="flex:1;">
      <div style="font-weight:600; margin-bottom:6px;">Curriculum cover</div>
      <div style="opacity:0.75; margin-bottom:10px;">
        This shows on the curriculum page and in listings.
      </div>

      <input id="coverInput" type="file" name="cover_image" accept="image/*" style="display:none;">

      <div style="display:flex; gap:10px; align-items:center;">
        <button type="button" id="chooseCoverBtn">Choose image</button>

        {% if curriculum.cover_image_url %}
          <button type="submit"
                  formaction="{{ url_for('author.curriculum_cover_remove', curriculum_id=curriculum.id) }}"
                  formmethod="POST">
            Remove
          </button>
        {% endif %}

        <div id="coverHint" style="font-size:13px; opacity:0.7;"></div>
      </div>
    </div>
  </div>


  </form>

{% endblock %}

{% block scripts %}
<script>
  function removeRow(btn) {
    const tr = btn.closest("tr");
    if (tr) tr.remove();
  }

  function syncRow(sel) {
    const tr = sel.closest("tr");
    if (!tr) return;

    const type = sel.value;

    const phaseWrap = tr.querySelector(".phase-wrap");
    const lessonWrap = tr.querySelector(".lesson-wrap");
    const repeatWrap = tr.querySelector(".repeat-wrap");

    if (!phaseWrap || !lessonWrap || !repeatWrap) return;

    const phaseTitle = tr.querySelector(".phase-title");
    const lessonSel = tr.querySelector(".lesson-id");
    const repeat = tr.querySelector(".repeat");

    if (type === "phase") {
      phaseWrap.style.display = "";
      lessonWrap.style.display = "none";
      repeatWrap.style.display = "none";

      // ensure consistent submitted values
      lessonSel.value = "";
      repeat.value = "1";
    } else {
      phaseWrap.style.display = "none";
      lessonWrap.style.display = "";
      repeatWrap.style.display = "";

      phaseTitle.value = "";
      if (!repeat.value) repeat.value = "1";
    }
  }

  function addPhaseRow() {
    const body = document.getElementById("items-body");
    body.insertAdjacentHTML("beforeend", phaseRowHtml());
    // sync last row
    const last = body.querySelector("tr.item-row:last-child select.item-type");
    syncRow(last);
  }

  function addLessonRow() {
    const body = document.getElementById("items-body");
    body.insertAdjacentHTML("beforeend", lessonRowHtml());
    const last = body.querySelector("tr.item-row:last-child select.item-type");
    syncRow(last);
  }

  function phaseRowHtml() {
    return `
      <tr class="item-row">
        <td>
          <select name="item_type" class="item-type" onchange="syncRow(this)">
            <option value="phase" selected>phase</option>
            <option value="lesson">lesson</option>
          </select>
        </td>

        <td>
          <div class="phase-wrap">
            <input type="text" name="phase_title" class="phase-title"
                   value="" placeholder="Phase name" style="width: 100%;">
          </div>
        </td>

        <td>
          <div class="lesson-wrap">
            <select name="lesson_id" class="lesson-id" style="width: 100%;">
              <option value="">-- choose lesson --</option>
              ${lessonOptionsHtml()}
            </select>
          </div>
        </td>

        <td style="text-align:center;">
          <div class="repeat-wrap">
            <input type="number" name="repeat" class="repeat" value="1" min="1" max="50" style="width: 70px;">
          </div>
        </td>

        <td>
          <input type="text" name="note" class="note" value="" placeholder="Optional note" style="width: 100%;">
        </td>

        <td style="text-align:center;">
          <button type="button" onclick="removeRow(this)">Remove</button>
        </td>
      </tr>
    `;
  }

  function lessonRowHtml() {
    return `
      <tr class="item-row">
        <td>
          <select name="item_type" class="item-type" onchange="syncRow(this)">
            <option value="phase">phase</option>
            <option value="lesson" selected>lesson</option>
          </select>
        </td>

        <td>
          <div class="phase-wrap">
            <input type="text" name="phase_title" class="phase-title"
                   value="" placeholder="Phase name" style="width: 100%;">
          </div>
        </td>

        <td>
          <div class="lesson-wrap">
            <select name="lesson_id" class="lesson-id" style="width: 100%;">
              <option value="">-- choose lesson --</option>
              ${lessonOptionsHtml()}
            </select>
          </div>
        </td>

        <td style="text-align:center;">
          <div class="repeat-wrap">
            <input type="number" name="repeat" class="repeat" value="1" min="1" max="50" style="width: 70px;">
          </div>
        </td>

        <td>
          <input type="text" name="note" class="note" value="" placeholder="Optional note" style="width: 100%;">
        </td>

        <td style="text-align:center;">
          <button type="button" onclick="removeRow(this)">Remove</button>
        </td>
      </tr>
    `;
  }

  function lessonOptionsHtml() {
    // server-rendered options embedded into JS safely
    return `{% for L in lessons %}<option value="{{ L.id|e }}">{{ (L.title ~ " (" ~ L.code ~ ")")|e }}</option>{% endfor %}`;
  }

  // Initialize existing rows on load
  window.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("select.item-type").forEach(syncRow);
  });

  function applyLessonFilter(text) {
    const needle = (text || "").trim().toLowerCase();
    document.querySelectorAll("select.lesson-id").forEach(sel => {
      Array.from(sel.options).forEach((opt, idx) => {
        if (idx === 0) { // keep "-- choose lesson --"
          opt.hidden = false;
          return;
        }
        const hay = (opt.textContent || "").toLowerCase();
        opt.hidden = (needle && !hay.includes(needle));
      });
    });
  }

  window.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll("select.item-type").forEach(syncRow);

    const lf = document.getElementById("lesson-filter");
    if (lf) {
      lf.addEventListener("input", () => applyLessonFilter(lf.value));
    }
  });

</script>

<script>
  (function () {
    const drop = document.getElementById("coverDrop");
    const input = document.getElementById("coverInput");
    const preview = document.getElementById("coverPreview");
    const chooseBtn = document.getElementById("chooseCoverBtn");
    const hint = document.getElementById("coverHint");

    if (!drop || !input || !preview || !chooseBtn) return;

    function pick() { input.click(); }

    function setPreview(file) {
      if (!file) return;
      if (!file.type.startsWith("image/")) {
        hint.textContent = "Please choose an image file.";
        return;
      }
      hint.textContent = "Ready ‚Äî click Save to upload.";
      preview.src = URL.createObjectURL(file);
      preview.style.display = "block";
    }

    chooseBtn.addEventListener("click", pick);
    drop.addEventListener("click", pick);

    input.addEventListener("change", () => {
      setPreview(input.files && input.files[0]);
    });

    // Drag & drop
    drop.addEventListener("dragover", (e) => { e.preventDefault(); drop.style.outline = "2px solid rgba(255,255,255,0.35)"; });
    drop.addEventListener("dragleave", () => { drop.style.outline = "none"; });
    drop.addEventListener("drop", (e) => {
      e.preventDefault();
      drop.style.outline = "none";
      const file = e.dataTransfer.files && e.dataTransfer.files[0];
      if (!file) return;
      // put it into the input so it submits normally
      const dt = new DataTransfer();
      dt.items.add(file);
      input.files = dt.files;
      setPreview(file);
    });
  })();
</script>


{% endblock %}

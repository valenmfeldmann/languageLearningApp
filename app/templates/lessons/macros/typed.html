{# app/templates/lessons/macros/typed.html #}

{% macro render_typed(val, lesson_id) %}
  {% if val is mapping %}
    {% set k = val.get("kind", "text") %}
    {% set v = val.get("value", "") %}

    {# --- NEW: Check for combined Text + Image format --- #}
    {% if val.get("text") and val.get("image") %}
      <div class="combined-choice-wrapper" style="text-align: center;">
        <img
          src="{{ url_for('lessons.asset', lesson_id=lesson_id, ref=val.get('image')) }}"
          alt=""
          style="max-width: 100%; height: auto; border-radius: 8px; display: block; margin: 0 auto 6px auto;"
        />
        <span class="choice-text" style="display: block; font-weight: 500;">{{ val.get("text") }}</span>
      </div>
    {% elif k == "text" %}
      {{ v }}
    {% elif k == "markdown" %}
      <div class="markdown-body">
        {{ v | markdown | safe }}
      </div>
    {% elif k == "image" %}
      <img
        src="{{ url_for('lessons.asset', lesson_id=lesson_id, ref=v) }}"
        alt=""
        {# Changed max-width to 100% to respect parent container bounds #}
        style="max-width: 100%; height: auto; border-radius: 10px; display: block;"
      />
    {% elif k == "audio" %}
      <audio controls src="{{ url_for('lessons.asset', lesson_id=lesson_id, ref=v) }}"
             style="width:100%; margin-top: 10px;"></audio>
    {% elif k == "video" %}
      <video controls preload="metadata"
             style="max-width:480px; height:auto; border-radius:10px; display:block;"
             src="{{ url_for('lessons.asset', lesson_id=lesson_id, ref=v) }}"></video>
    {% elif k == "trivia_launcher" %}
      <div class="panel-like trivia-launcher-card"
           style="padding: 24px; text-align: center; border: 1px solid rgba(168,199,255,0.3); border-radius: 16px; background: rgba(168,199,255,0.05); margin: 20px 0;">
          <div style="font-size: 40px; margin-bottom: 12px;">üèÜ</div>
          <h3 style="margin-top: 0; color: var(--link);">{{ val.get("title", "Knowledge Check") }}</h3>
          <p class="muted" style="margin-bottom: 20px;">
            {{ val.get("description", "Ready to test what you just learned? Launch a trivia session now.") }}
          </p>

          {# Build the URL with the specific query and subject #}
          <a href="{{ url_for('appui.trivia_page', q=val.get('query', ''), subject=val.get('subject', '')) }}"
             class="btn primary" style="padding: 12px 24px; font-size: 16px;">
             Launch Trivia Session &rarr;
          </a>
      </div>
    {% else %}
      <code>[{{ k }}]</code> {{ v }}
    {% endif %}
  {% else %}
    {{ val }}
  {% endif %}
{% endmacro %}
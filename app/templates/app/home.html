{% extends "base.html" %}
{% block content %}

<style>
  .explore-top {
    display:flex;
    gap:12px;
    align-items:center;
    flex-wrap:wrap;
    margin: 14px 0 18px 0;
  }
  .explore-top input, .explore-top select {
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid rgba(255,255,255,0.18);
    background: rgba(255,255,255,0.04);
    color: inherit;
  }
  .explore-top input { width: min(520px, 100%); }
  .explore-grid {
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 16px;
    margin-top: 8px;
  }
  .card {
    display:block;
    text-decoration:none;
    color: inherit;
  }
  .thumb {
    width:100%;
    aspect-ratio: 16 / 9;
    border-radius: 14px;
    overflow:hidden;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.10);
  }
  .thumb img {
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }
  .meta {
    margin-top: 10px;
    display:flex;
    flex-direction:column;
    gap: 4px;
  }
  .title {
    font-weight: 650;
    line-height: 1.25;
    display:-webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow:hidden;
  }
  .sub {
    font-size: 13px;
    opacity: 0.75;
    display:flex;
    gap: 8px;
    flex-wrap:wrap;
  }
  .stats {
    font-size: 13px;
    opacity: 0.80;
    display:flex;
    gap: 10px;
    flex-wrap:wrap;
    margin-top: 2px;
  }
</style>

<div style="display:flex; align-items: baseline; gap: 12px;">
  <h1 style="margin:0;">Explore</h1>
  <a href="{{ url_for('main.curriculum_index') }}" style="font-size: 14px; opacity: 0.85;">All curriculums (list view)</a>
</div>

{% if continue_lesson %}
  <p style="margin-top: 10px;">
    <a class="btn btn-primary"
       href="{{ url_for('main.lesson_page', lesson_code=continue_lesson.code, src='home') }}">
      Continue {{ continue_lesson.title }}
    </a>
  </p>
{% endif %}

<form class="explore-top" method="GET" action="{{ url_for('main.app_home') }}">
  <input type="text" name="q" value="{{ q or '' }}" placeholder="Search curriculums…">

  <select name="subject">
    <option value="">All subjects</option>
    {% for s in subjects %}
      <option value="{{ s.code }}" {% if subject_code == s.code %}selected{% endif %}>
        {{ s.name }}
      </option>
    {% endfor %}
  </select>

  <select name="school">
    <option value="">All schools</option>
    {% for sc in schools %}
      <option value="{{ sc }}" {% if school_code == sc %}selected{% endif %}>
        {{ sc }}
      </option>
    {% endfor %}
  </select>

  <select name="sort">
    <option value="new" {% if sort == 'new' %}selected{% endif %}>Newest</option>
    <option value="market_cap" {% if sort == 'market_cap' %}selected{% endif %}>Market cap</option>
    <option value="title" {% if sort == 'title' %}selected{% endif %}>Title</option>
  </select>

  <button type="submit">Search</button>
</form>

<div class="explore-grid">
  {% for row in cards %}
    {% set cur = row.curriculum %}
    <a class="card" href="{{ url_for('main.curriculum_view', curriculum_code=cur.code) }}">
      <div class="thumb">
        {% if cur.cover_image_url %}
          <img src="{{ cur.cover_image_url }}" alt="{{ cur.title }}">
        {% else %}
          <div style="height:100%; display:flex; align-items:center; justify-content:center; opacity:0.6;">
            No cover
          </div>
        {% endif %}
      </div>

      <div class="meta">
        <div class="title">{{ cur.title }}</div>

        <div class="sub">
          {% if cur.school_code %}<span>{{ cur.school_code }}</span>{% endif %}
          {% if cur.subject_code %}<span>• {{ cur.subject_code }}</span>{% endif %}
        </div>

        <div class="stats">
          <span>{{ row.lesson_count }} lessons</span>
          <span>• {{ "%.2f"|format(row.market_cap_an) }} AN</span>
        </div>
      </div>
    </a>
  {% endfor %}
</div>

{% if current_user.is_authenticated %}
  <hr style="margin: 24px 0;">
  <h3>Author</h3>
  <ul>
    <li><a href="{{ url_for('author.lesson_index') }}">My Lessons</a></li>
    <li><a href="{{ url_for('author.curriculum_new_form') }}">New Curriculum</a></li>
    <li><a href="{{ url_for('author.lesson_new_form') }}">New Lesson</a></li>
  </ul>
{% endif %}

{% endblock %}

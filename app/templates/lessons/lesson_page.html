{% extends "base.html" %}

{% block head %}
<style>

  /* Outer lesson outline */
  .lesson-shell {
    background: rgba(16, 20, 32, 0.78);
    border: 1px solid var(--border);
    border-radius: 18px;
    box-shadow: var(--shadow);
    padding: 22px;
  }

  /* Subtle focus on hover */
  .lesson-block:hover {
    background: rgba(255,255,255,0.045);
  }

  /* Header inside lesson */
  .lesson-header {
    margin-bottom: 22px;
  }

  .lesson-header h1 {
    margin-bottom: 4px;
  }

  .lesson-header .attempt {
    color: var(--muted);
    font-size: 13px;
  }
</style>
{% endblock %}

{% block content %}
<div class="lesson-container lesson-shell panel">

  {% if back_to_curriculum %}
      <div style="margin-bottom: 20px;">
          <a href="{{ url_for('main.curriculum_view', curriculum_code=back_to_curriculum) }}"
             class="btn" style="opacity: 0.8; font-size: 13px;">
              &larr; Back to Curriculum
          </a>
      </div>
  {% endif %}


  <header style="margin-bottom: 30px; display: flex; justify-content: space-between; align-items: flex-start;">
    <div>
      <h1 style="margin-bottom: 5px;">{{ lesson.title }}</h1>
      <div style="display: flex; gap: 15px; align-items: center;">
        <span class="muted" style="font-size: 13px;">Attempt #{{ attempt.id[:8] }}</span>
        {% if is_author %}
          <span style="background: rgba(168,199,255,0.1); color: var(--link); padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; text-transform: uppercase;">Author View</span>
        {% endif %}
      </div>
    </div>

    {% if is_author %}
      <a href="{{ url_for('author.lesson_edit', lesson_id=lesson.id) }}"
         class="btn"
         style="background: #1a1a1a; border: 1px solid #333; color: white; padding: 10px 18px; border-radius: 10px; text-decoration: none; font-size: 14px; display: flex; align-items: center; gap: 8px; transition: border-color 0.2s;">
         <span>✏️</span> Edit Lesson
      </a>
    {% endif %}
  </header>




  {% for item in block_views %}
    {% set b = item.b %}
    <div class="lesson-block" id="block-{{ b.id }}" data-block-id="{{ b.id }}">
      {% include item.tpl %}
    </div>
  {% endfor %}






  <div class="lesson-footer" style="margin-top: 50px; padding-top: 30px; border-top: 1px solid var(--border);">
    {% if can_complete %}
      <form class="lessons-filters" method="POST" action="{{ url_for('main.complete_lesson', lesson_code=lesson.code) }}">
        <input type="hidden" name="attempt_id" value="{{ attempt.id }}">

        <div style="margin-bottom: 25px; text-align: center;">
          <h3 style="margin-bottom: 15px;">How was this lesson?</h3>
          <div class="rating-stars" style="display: flex; justify-content: center; gap: 15px; flex-direction: row-reverse;">
            {% for i in range(5, 0, -1) %}
              <input type="radio" name="rating" value="{{ i }}" id="star{{ i }}" required style="display:none;">
              <label for="star{{ i }}" style="font-size: 30px; cursor: pointer; color: #444; transition: color 0.2s;">★</label>
            {% endfor %}
          </div>
          <p class="muted" style="margin-top: 10px; font-size: 13px;">Please select a rating to finish.</p>
        </div>

        <button type="submit" class="btn-complete" style="width: 100%;">✓ Complete Lesson</button>
      </form>
    {% else %}
      <div class="status-note">Complete all quizzes above to finish this lesson.</div>
    {% endif %}
  </div>

  <style>
    /* Hover effect for star rating */
    .rating-stars label:hover,
    .rating-stars label:hover ~ label,
    .rating-stars input:checked ~ label {
      color: var(--link) !important;
    }
  </style>






</div>
{% endblock %}

{% block scripts %}
<script>
  window.addEventListener("DOMContentLoaded", () => {
    if (!location.hash) return;
    setTimeout(() => {
      const el = document.querySelector(location.hash);
      if (el) el.scrollIntoView({ block: "start", behavior: "smooth" });
    }, 50);
  });
</script>
<script>
  let currentBlockId = null;

  // Track which block is currently in the viewport
  const observer = new IntersectionObserver(entries => {
    entries.forEach(e => {
      if (e.isIntersecting) {
        currentBlockId = e.target.dataset.blockId;
      }
    });
  }, { threshold: 0.6 });

  document.querySelectorAll(".lesson-block").forEach(el => observer.observe(el));

  // Heartbeat to track time spent per block
  setInterval(() => {
    // Only send heartbeat if a block is actually in view
    if (currentBlockId) {
      fetch("{{ url_for('main.lesson_heartbeat') }}", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          attempt_id: "{{ attempt.id }}",
          lesson_block_id: currentBlockId,
          seconds_delta: 10,
        })
      }).catch(err => console.error("Heartbeat failed", err));
    }
  }, 10000);
</script>
{% endblock %}
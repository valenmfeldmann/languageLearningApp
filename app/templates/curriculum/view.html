{% extends "base.html" %}
{% block title %}{{ curriculum.title }}{% endblock %}

{% block content %}
  <div style="display:flex; align-items:baseline; gap: 12px;">
    <h1 style="margin:0;">{{ curriculum.title }}</h1>
    <a href="{{ url_for('main.curriculum_index') }}" style="font-size: 14px;">‚Üê all curriculums</a>

    {% if can_manage %}
      <form method="post" action="{{ url_for('main.payout_curriculum', curriculum_code=curriculum.code) }}"
            style="display:inline;">
        <button type="submit">Payout now</button>
      </form>
    {% endif %}

    {% if can_view_analytics %}
      <a href="{{ url_for('main.curriculum_analytics', curriculum_code=curriculum.code) }}">Analytics</a>
    {% endif %}

    {% if can_edit %}
      <a href="{{ url_for('author.curriculum_edit', curriculum_id=curriculum.id) }}">Edit</a>
    {% endif %}
  </div>

  {% if curriculum.description %}
    <p style="opacity:0.85; margin-top: 10px;">{{ curriculum.description }}</p>
  {% endif %}



<!--  &lt;!&ndash; Trading UI &ndash;&gt;-->
<!--  <div style="margin-top: 18px; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">-->
<!--    <h3 style="margin: 0 0 10px 0;">Trade curriculum shares</h3>-->

<!--    <div style="opacity:0.85; margin-bottom: 10px;">-->
<!--      <div>Your balance: <b>{{ my_an_ticks / AN_SCALE }}</b> AN</div>-->
<!--      <div>Your shares: <b>{{ my_shares }}</b></div>-->
<!--      <div>Curriculum treasury: <b>{{ curriculum_an_ticks / AN_SCALE }}</b> AN</div>-->
<!--      <div>Total shares outstanding: <b>{{ total_shares_outstanding }}</b></div>-->
<!--      <div>Your ownership: <b>{{ ownership_pct | round(2) }}%</b></div>-->
<!--    </div>-->

<!--    <div style="display:flex; gap: 16px; flex-wrap: wrap; align-items:flex-start;">-->
<!--      &lt;!&ndash; Place order form &ndash;&gt;-->
<!--      <div style="min-width: 320px;">-->
<!--        <form method="post" action="{{ url_for('main.place_curriculum_order', curriculum_code=curriculum.code) }}">-->
<!--          <div style="display:flex; gap: 10px; align-items:center; flex-wrap: wrap;">-->
<!--            <label>Side-->
<!--              <select name="side">-->
<!--                <option value="bid">Bid (buy shares)</option>-->
<!--                <option value="ask">Ask (sell shares)</option>-->
<!--              </select>-->
<!--            </label>-->

<!--            <label>Price (AN/share)-->
<!--              <input name="price_an" type="number" step="0.001" min="0.001" required style="width: 120px;">-->
<!--            </label>-->

<!--            <label>Qty (shares)-->
<!--              <input name="qty" type="number" step="1" min="1" required style="width: 100px;">-->
<!--            </label>-->

<!--            <button type="submit">Place order</button>-->
<!--          </div>-->
<!--          <div style="font-size: 12px; opacity:0.7; margin-top: 6px;">-->
<!--            1 AN = {{ AN_SCALE }} ticks. Orders escrow funds/shares immediately.-->
<!--          </div>-->
<!--        </form>-->
<!--      </div>-->

<!--      &lt;!&ndash; My open orders &ndash;&gt;-->
<!--      <div style="min-width: 360px;">-->
<!--        <div style="font-weight: 600; margin-bottom: 6px;">My open orders</div>-->
<!--        {% if my_open_orders %}-->
<!--          <table style="border-collapse: collapse; width: 100%;">-->
<!--            <tr style="text-align:left; border-bottom:1px solid #ddd;">-->
<!--              <th style="padding:6px;">Side</th>-->
<!--              <th style="padding:6px;">Price (AN)</th>-->
<!--              <th style="padding:6px;">Remaining</th>-->
<!--              <th style="padding:6px;"></th>-->
<!--            </tr>-->
<!--            {% for o in my_open_orders %}-->
<!--              <tr style="border-bottom:1px solid #eee;">-->
<!--                <td style="padding:6px;">{{ o.side }}</td>-->
<!--                <td style="padding:6px;">{{ (o.price_ticks / AN_SCALE) }}</td>-->
<!--                <td style="padding:6px;">{{ o.qty_remaining }}</td>-->
<!--                <td style="padding:6px;">-->
<!--                  <form method="post" action="{{ url_for('main.cancel_order', order_id=o.id) }}">-->
<!--                    <button type="submit">Cancel</button>-->
<!--                  </form>-->
<!--                </td>-->
<!--              </tr>-->
<!--            {% endfor %}-->
<!--          </table>-->
<!--        {% else %}-->
<!--          <div style="opacity:0.75;">No open orders.</div>-->
<!--        {% endif %}-->
<!--      </div>-->
<!--    </div>-->




  <details style="margin-top: 24px; border: 1px solid rgba(168, 199, 255, 0.2); border-radius: 12px; background: var(--card); overflow: hidden; box-shadow: 0 4px 20px rgba(0,0,0,0.3);" {% if my_open_orders %}open{% endif %}>
    <summary style="padding: 16px 20px; cursor: pointer; font-weight: bold; background: rgba(168, 199, 255, 0.05); list-style: none; display: flex; justify-content: space-between; align-items: center;">
      <span style="display: flex; align-items: center; gap: 10px;">
        <span style="font-size: 1.2rem;">üìà</span> Trade Curriculum Shares
      </span>
      <span class="muted" style="font-size: 0.8rem; font-weight: normal;">Click to expand market controls</span>
    </summary>

    <div style="padding: 24px; border-top: 1px solid rgba(168, 199, 255, 0.1);">

      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; padding: 16px; background: rgba(0,0,0,0.2); border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);">
        <div>
          <div class="muted" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Your Balance</div>
          <div style="font-size: 1.1rem; font-weight: bold; color: var(--link);">{{ my_an_ticks / AN_SCALE }} <span style="font-size: 0.8rem; font-weight: normal;">AN</span></div>
        </div>
        <div>
          <div class="muted" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Your Shares</div>
          <div style="font-size: 1.1rem; font-weight: bold;">{{ my_shares }}</div>
        </div>
        <div>
          <div class="muted" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Treasury</div>
          <div style="font-size: 1.1rem; font-weight: bold;">{{ curriculum_an_ticks / AN_SCALE }} <span style="font-size: 0.8rem; font-weight: normal;">AN</span></div>
        </div>
        <div>
          <div class="muted" style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">Ownership</div>
          <div style="font-size: 1.1rem; font-weight: bold;">{{ ownership_pct | round(2) }}%</div>
        </div>
      </div>

      <div style="display:flex; gap: 32px; flex-wrap: wrap; align-items:flex-start;">
        <div style="flex: 1; min-width: 320px;">


          <h4 style="margin: 0 0 16px 0; font-size: 0.9rem; color: var(--muted); text-transform: uppercase;">New Order</h4>


          <div style="margin-bottom: 24px; padding: 16px; background: rgba(168, 199, 255, 0.03); border: 1px dashed rgba(168, 199, 255, 0.2); border-radius: 8px;">
              <h4 style="margin: 0 0 12px 0; font-size: 0.75rem; color: var(--muted); text-transform: uppercase; letter-spacing: 1px;">Market Quick Trade</h4>

              <div style="display: flex; gap: 12px; flex-wrap: wrap;">

                  {% set best_ask = asks[0] if asks else None %}
                  <form method="post" action="{{ url_for('main.place_curriculum_order', curriculum_code=curriculum.code) }}" style="flex: 1; min-width: 150px;">
                      <input type="hidden" name="side" value="bid">
                      <input type="hidden" name="qty" value="1"> <input type="hidden" name="price_an" value="{{ (best_ask.price_ticks / AN_SCALE) if best_ask else '' }}">

                      <button type="submit"
                              {% if not best_ask %}disabled{% endif %}
                              style="width: 100%; padding: 10px; border-radius: 6px; border: none; font-weight: bold; cursor: {{ 'pointer' if best_ask else 'not-allowed' }};
                                     background: {{ 'var(--link)' if best_ask else '#222' }};
                                     color: {{ '#000' if best_ask else 'var(--muted)' }};
                                     opacity: {{ '1' if best_ask else '0.5' }};">
                          {% if best_ask %}
                              Buy 1 at {{ "%.3f"|format(best_ask.price_ticks / AN_SCALE) }} AN
                          {% else %}
                              No Sellers
                          {% endif %}
                      </button>
                  </form>

                  {% set best_bid = bids[0] if bids else None %}
                  <form method="post" action="{{ url_for('main.place_curriculum_order', curriculum_code=curriculum.code) }}" style="flex: 1; min-width: 150px;">
                      <input type="hidden" name="side" value="ask">
                      <input type="hidden" name="qty" value="1">
                      <input type="hidden" name="price_an" value="{{ (best_bid.price_ticks / AN_SCALE) if best_bid else '' }}">

                      <button type="submit"
                              {% if not best_bid %}disabled{% endif %}
                              style="width: 100%; padding: 10px; border-radius: 6px; border: none; font-weight: bold; cursor: {{ 'pointer' if best_bid else 'not-allowed' }};
                                     background: {{ '#ff6b6b' if best_bid else '#222' }};
                                     color: {{ '#000' if best_bid else 'var(--muted)' }};
                                     opacity: {{ '1' if best_bid else '0.5' }};">
                          {% if best_bid %}
                              Sell 1 at {{ "%.3f"|format(best_bid.price_ticks / AN_SCALE) }} AN
                          {% else %}
                              No Buyers
                          {% endif %}
                      </button>
                  </form>

              </div>
              <div style="margin-top: 8px; font-size: 11px; text-align: center;" class="muted">
                  Market orders execute instantly against the best current price.
              </div>
          </div>



          <form method="post" action="{{ url_for('main.place_curriculum_order', curriculum_code=curriculum.code) }}">
            <div style="display: flex; flex-direction: column; gap: 12px;">
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <label>Side
                  <select name="side" style="width: 100%; margin-top: 4px; background: #000; border: 1px solid #333; color: #fff; padding: 8px; border-radius: 6px;">
                    <option value="bid">Bid (Buy)</option>
                    <option value="ask">Ask (Sell)</option>
                  </select>
                </label>
                <label>Price (AN/Share)
                  <input name="price_an" type="number" step="0.001" min="0.001" required style="width: 100%; margin-top: 4px; background: #000; border: 1px solid #333; color: #fff; padding: 8px; border-radius: 6px;">
                </label>
              </div>

              <label>Quantity (Shares)
                <input name="qty" type="number" step="1" min="1" required style="width: 100%; margin-top: 4px; background: #000; border: 1px solid #333; color: #fff; padding: 8px; border-radius: 6px;">
              </label>

              <button type="submit" class="btn" style="width: 100%; padding: 12px; font-weight: bold; background: var(--link); color: #000;">Place Order</button>
            </div>
            <div style="font-size: 11px; opacity:0.5; margin-top: 10px; text-align: center;">
              Escrowed immediately. 1 AN = {{ AN_SCALE }} ticks.
            </div>
          </form>
        </div>

        <div style="flex: 1.5; min-width: 360px;">
          <h4 style="margin: 0 0 16px 0; font-size: 0.9rem; color: var(--muted); text-transform: uppercase;">My Open Orders</h4>
          {% if my_open_orders %}
            <div style="border-radius: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.05);">
              <table style="border-collapse: collapse; width: 100%; font-size: 0.9rem;">
                <tr style="text-align:left; background: rgba(255,255,255,0.02); border-bottom: 1px solid rgba(255,255,255,0.1);">
                  <th style="padding:12px;">Side</th>
                  <th style="padding:12px;">Price</th>
                  <th style="padding:12px;">Rem.</th>
                  <th style="padding:12px;">Action</th>
                </tr>
                {% for o in my_open_orders %}
                  <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                    <td style="padding:12px;"><span style="color: {{ 'var(--link)' if o.side == 'bid' else '#ff6b6b' }}; font-weight: bold;">{{ o.side|upper }}</span></td>
                    <td style="padding:12px;">{{ (o.price_ticks / AN_SCALE) }} <span class="muted" style="font-size: 0.7rem;">AN</span></td>
                    <td style="padding:12px;">{{ o.qty_remaining }}</td>
                    <td style="padding:12px;">
                      <form method="post" action="{{ url_for('main.cancel_order', order_id=o.id) }}">
                        <button type="submit" class="btn small" style="background: rgba(255,0,0,0.1); color: #ff6b6b; border: 1px solid rgba(255,107,107,0.2); padding: 4px 8px; font-size: 11px;">Cancel</button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              </table>
            </div>
          {% else %}
            <div style="text-align: center; padding: 40px; background: rgba(0,0,0,0.1); border-radius: 8px; border: 1px dashed rgba(255,255,255,0.1);">
              <div class="muted">No active orders found.</div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </details>



<!--    &lt;!&ndash; Order book &ndash;&gt;-->
<!--    <div style="display:flex; gap: 24px; margin-top: 14px; flex-wrap: wrap;">-->
<!--      <div style="min-width: 360px;">-->
<!--        <div style="font-weight: 600; margin-bottom: 6px;">Bids (buyers)</div>-->
<!--        {% if bids %}-->
<!--          <table style="border-collapse: collapse; width: 100%;">-->
<!--            <tr style="text-align:left; border-bottom:1px solid #ddd;">-->
<!--              <th style="padding:6px;">Price (AN)</th>-->
<!--              <th style="padding:6px;">Qty</th>-->
<!--              <th style="padding:6px;">User</th>-->
<!--            </tr>-->
<!--            {% for o in bids %}-->
<!--              <tr style="border-bottom:1px solid #eee;">-->
<!--                <td style="padding:6px;">{{ (o.price_ticks / AN_SCALE) }}</td>-->
<!--                <td style="padding:6px;">{{ o.qty_remaining }}</td>-->
<!--                <td style="padding:6px;">{{ o.user_id[:8] }}‚Ä¶</td>-->
<!--              </tr>-->
<!--            {% endfor %}-->
<!--          </table>-->
<!--        {% else %}-->
<!--          <div style="opacity:0.75;">No bids.</div>-->
<!--        {% endif %}-->
<!--      </div>-->

<!--      <div style="min-width: 360px;">-->
<!--        <div style="font-weight: 600; margin-bottom: 6px;">Asks (sellers)</div>-->
<!--        {% if asks %}-->
<!--          <table style="border-collapse: collapse; width: 100%;">-->
<!--            <tr style="text-align:left; border-bottom:1px solid #ddd;">-->
<!--              <th style="padding:6px;">Price (AN)</th>-->
<!--              <th style="padding:6px;">Qty</th>-->
<!--              <th style="padding:6px;">User</th>-->
<!--            </tr>-->
<!--            {% for o in asks %}-->
<!--              <tr style="border-bottom:1px solid #eee;">-->
<!--                <td style="padding:6px;">{{ (o.price_ticks / AN_SCALE) }}</td>-->
<!--                <td style="padding:6px;">{{ o.qty_remaining }}</td>-->
<!--                <td style="padding:6px;">{{ o.user_id[:8] }}‚Ä¶</td>-->
<!--              </tr>-->
<!--            {% endfor %}-->
<!--          </table>-->
<!--        {% else %}-->
<!--          <div style="opacity:0.75;">No asks.</div>-->
<!--        {% endif %}-->
<!--      </div>-->
<!--    </div>-->
<!--  </div>-->



  <details style="margin-top: 14px; border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 12px; background: rgba(16, 20, 32, 0.4); overflow: hidden;">
    <summary style="padding: 12px 20px; cursor: pointer; font-weight: 600; background: rgba(255, 255, 255, 0.03); display: flex; align-items: center; gap: 10px; font-size: 0.9rem;">
      <span>üìä</span> View Market Order Book
      <span class="muted" style="font-size: 0.75rem; font-weight: normal; margin-left: auto;">{{ bids|length + asks|length }} open orders</span>
    </summary>

    <div style="display:flex; gap: 2px; background: rgba(255, 255, 255, 0.05); flex-wrap: wrap;">

      <div style="flex: 1; min-width: 340px; background: var(--card); padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h4 style="margin: 0; color: var(--link); font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px;">Bids (Buyers)</h4>
          <span class="muted" style="font-size: 0.7rem;">Highest Price First</span>
        </div>

        {% if bids %}
          <table style="border-collapse: collapse; width: 100%; font-size: 0.9rem; font-family: 'JetBrains Mono', monospace;">
            <tr style="text-align:left; border-bottom: 1px solid rgba(255,255,255,0.1);">
              <th style="padding:8px 4px; color: var(--muted); font-weight: normal; font-size: 0.75rem;">Price (AN)</th>
              <th style="padding:8px 4px; color: var(--muted); font-weight: normal; font-size: 0.75rem;">Qty</th>
              <th style="padding:8px 4px; color: var(--muted); font-weight: normal; font-size: 0.75rem; text-align: right;">User</th>
            </tr>
            {% for o in bids %}
              <tr style="border-bottom: 1px solid rgba(255,255,255,0.03); transition: background 0.2s;" onmouseover="this.style.background='rgba(168,199,255,0.05)'" onmouseout="this.style.background='transparent'">
                <td style="padding:10px 4px; color: var(--link); font-weight: bold;">{{ "%.3f"|format(o.price_ticks / AN_SCALE) }}</td>
                <td style="padding:10px 4px;">{{ o.qty_remaining }}</td>
                <td style="padding:10px 4px; text-align: right;" class="muted">{{ o.user_id[:8] }}‚Ä¶</td>
              </tr>
            {% endfor %}
          </table>
        {% else %}
          <div style="padding: 40px 0; text-align: center;" class="muted">No active buy orders.</div>
        {% endif %}
      </div>

      <div style="flex: 1; min-width: 340px; background: var(--card); padding: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
          <h4 style="margin: 0; color: #ff6b6b; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px;">Asks (Sellers)</h4>
          <span class="muted" style="font-size: 0.7rem;">Lowest Price First</span>
        </div>

        {% if asks %}
          <table style="border-collapse: collapse; width: 100%; font-size: 0.9rem; font-family: 'JetBrains Mono', monospace;">
            <tr style="text-align:left; border-bottom: 1px solid rgba(255,255,255,0.1);">
              <th style="padding:8px 4px; color: var(--muted); font-weight: normal; font-size: 0.75rem;">Price (AN)</th>
              <th style="padding:8px 4px; color: var(--muted); font-weight: normal; font-size: 0.75rem;">Qty</th>
              <th style="padding:8px 4px; color: var(--muted); font-weight: normal; font-size: 0.75rem; text-align: right;">User</th>
            </tr>
            {% for o in asks %}
              <tr style="border-bottom: 1px solid rgba(255,255,255,0.03); transition: background 0.2s;" onmouseover="this.style.background='rgba(255,107,107,0.05)'" onmouseout="this.style.background='transparent'">
                <td style="padding:10px 4px; color: #ff6b6b; font-weight: bold;">{{ "%.3f"|format(o.price_ticks / AN_SCALE) }}</td>
                <td style="padding:10px 4px;">{{ o.qty_remaining }}</td>
                <td style="padding:10px 4px; text-align: right;" class="muted">{{ o.user_id[:8] }}‚Ä¶</td>
              </tr>
            {% endfor %}
          </table>
        {% else %}
          <div style="padding: 40px 0; text-align: center;" class="muted">No active sell orders.</div>
        {% endif %}
      </div>
    </div>
  </details>



  <style>
    /* 1. General Container & Track Logic */
    .curriculum-container {
      margin-top: 24px;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 16px;
      padding: 30px 20px;
      position: relative;
    }

    .curriculum-track {
      position: relative;
      padding-left: 24px;
    }

    /* The vertical progress line */
    .curriculum-track::before {
      content: '';
      position: absolute;
      left: 7px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: linear-gradient(to bottom,
        transparent,
        rgba(168, 199, 255, 0.2) 5%,
        rgba(168, 199, 255, 0.2) 95%,
        transparent);
      z-index: 1;
    }

    /* 2. Hybrid Phase Logic */
    .phase-row {
      margin: 32px 0 16px 0;
      width: 100%;
      position: relative;
      z-index: 2;
    }

    /* MAIN HEADER (# Title): Centered & Full Width */
    .phase-content:has(h1) {
      text-align: center;
      display: block;
    }


    .phase-content h1 {
        display: block;              /* Changed from inline-block to span full width */
        background: var(--bg);       /* Cuts the vertical progress line */
        color: var(--link);
        padding: 16px 20px;          /* Slightly more vertical breathing room */
        font-size: 1.6rem;
        font-weight: 900;
        text-transform: uppercase;
        letter-spacing: 2px;
        border-top: 1px solid rgba(168, 199, 255, 0.2);
        border-bottom: 1px solid rgba(168, 199, 255, 0.2);
        margin: 0;                   /* Reset any default markdown margins */
        width: 100%;                 /* Ensures it fills the track width */
        box-sizing: border-box;
    }


    /* SUB-PHASE (## Title or text): Left-aligned on the track */
    .phase-content:not(:has(h1)) {
      text-align: left;
      margin-left: -32px;
    }

    .phase-content h2,
    .phase-content p {
      display: inline-block;
      background: var(--bg);
      padding: 4px 16px;
      border: 2px solid rgba(168, 199, 255, 0.3);
      border-radius: 50px;
      color: var(--link);
      font-size: 0.85rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 1px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
      margin: 0;
    }

    /* 3. Lesson Cards */
    .lesson-card {
      position: relative;
      z-index: 2;
      background: var(--card);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 16px;
      transition: all 0.2s ease;
      text-decoration: none !important;
    }

    .lesson-card:hover {
      transform: translateX(8px);
      border-color: var(--link);
      background: rgba(168, 199, 255, 0.05);
    }

    .status-indicator {
      flex-shrink: 0;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      border: 2px solid rgba(255, 255, 255, 0.15);
      background: #000;
    }

    .status-done {
      background: var(--link);
      border-color: var(--link);
      color: #000;
      box-shadow: 0 0 10px rgba(168, 199, 255, 0.4);
    }

    .lesson-info { flex: 1; }
    .lesson-title { display: block; font-weight: bold; margin-bottom: 2px; }
    .lesson-meta { font-size: 0.8rem; display: flex; gap: 10px; }
  </style>



  <div class="curriculum-container">
    <div class="curriculum-track">
      {% for it in items %}
        {% if it.kind == "phase" %}
          <div class="phase-row">
            <div class="phase-content">
              {{ it.html_content }}
            </div>
          </div>

        {% elif it.kind == "lesson" %}
          {% if it.lesson %}
            <a href="{{ url_for('main.lesson_page',
                                lesson_code=it.lesson.code,
                                src='curriculum_view',
                                curriculum=curriculum.code,
                                pos=loop.index0) }}"
               class="lesson-card">

              <div class="status-indicator {{ 'status-done' if it.is_done else '' }}">
                {% if it.is_done %}‚úì{% endif %}
              </div>

              <div class="lesson-info">
                <span class="lesson-title">{{ it.lesson.title }}</span>
                <div class="lesson-meta">
                  {% if it.rating_count > 0 %}
                    <span style="color: #ffca28;">‚òÖ {{ "%.1f"|format(it.rating_avg) }}</span>
                    <span style="color: var(--link); font-weight: bold; opacity: 0.9;">Q: {{ "%.2f"|format(it.quality_score) }}</span>
                  {% endif %}
                  <span class="muted">Attempt {{ it.occurrence }}</span>
                </div>
              </div>
              <div class="muted" style="opacity: 0.4;">‚Üí</div>
            </a>
          {% endif %}
        {% endif %}
      {% endfor %}
    </div>
  </div>

{% endblock %}

<!doctype html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>{% block title %}GamifyLearning (Beta){% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">


  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/github-markdown-css/5.2.0/github-markdown-light.min.css">
  <style>
    .markdown-body {
      box-sizing: border-box;
      min-width: 200px;
      max-width: 980px;
      margin: 0 auto;
      padding: 45px;
      background-color: transparent !important;
      color: inherit !important;
    }
  </style>

  <style>

    .announcement-banner {
        /* Solid color makes it much more obvious than a transparent one */
        background: #1a2333;
        border-bottom: 2px solid var(--link); /* Thick cyan border from your theme */
        color: var(--text);
        padding: 12px 20px;
        text-align: center;
        font-size: 14px;
        font-weight: 700;
        letter-spacing: 0.3px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5); /* Adds depth to the nav */
        z-index: 1001;
        position: relative;
    }

    .announcement-banner .badge {
        background: var(--link);
        color: #000;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 11px;
        margin-right: 10px;
        text-transform: uppercase;
    }


    /* Basic responsive defaults */
    img, video { max-width: 100%; height: auto; }
    .container { max-width: 1100px; margin: 0 auto; padding: 0 16px; }

    /* Mobile tweaks */
    @media (max-width: 768px) {
      .container { padding: 0 12px; }

      /* If your top nav is a flex row, let it wrap */
      .top-nav { flex-wrap: wrap; gap: 10px; }

      /* Reduce giant headings on phone */
      h1 { font-size: 2rem; }
      h2 { font-size: 1.4rem; }

      /* Make ‚Äúcard‚Äù sections fit */
      .card, .panel { width: 100%; }
    }
  </style>


  <style>
    :root{
      --bg: #0b0d12;
      --panel: #101420;
      --card: #121829;
      --text: #e9edf7;
      --muted: rgba(233,237,247,.72);
      --border: rgba(233,237,247,.12);
      --shadow: 0 12px 34px rgba(0,0,0,.35);
      --radius: 14px;
      --maxw: 1120px;
      --link: #a8c7ff;
      --linkHover: #d7e6ff;
      --danger: #ff6b6b;
      --ok: #3ddc97;
      --warn: #ffd166;
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 30% -10%, rgba(168,199,255,.12), transparent 60%),
                  radial-gradient(900px 600px at 90% 10%, rgba(61,220,151,.10), transparent 55%),
                  var(--bg);
      color: var(--text);
      line-height:1.45;
    }

    a{ color: var(--link); text-decoration:none; }
    a:hover{ color: var(--linkHover); text-decoration:underline; }

    .container{
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 22px 18px;
    }

    header{
      position: sticky;
      top: 0;
      z-index: 50;
      backdrop-filter: blur(10px);
      background: linear-gradient(to bottom, rgba(11,13,18,.85), rgba(11,13,18,.55));
      border-bottom: 1px solid var(--border);
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      padding: 14px 18px;
      max-width: var(--maxw);
      margin: 0 auto;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 800;
      letter-spacing: .2px;
      white-space: nowrap;
    }
    .brand-badge{
      width: 30px;
      height: 30px;
      border-radius: 10px;
      background: linear-gradient(135deg, rgba(168,199,255,.9), rgba(61,220,151,.85));
      box-shadow: 0 10px 26px rgba(0,0,0,.35);
    }
    .brand small{
      display:block;
      font-weight: 600;
      color: var(--muted);
      margin-top: -2px;
    }

    nav{
      display:flex;
      align-items:center;
      gap: 10px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .navlink{
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid transparent;
      color: var(--text);
      opacity:.92;
    }
    .navlink:hover{
      text-decoration:none;
      border-color: var(--border);
      background: rgba(255,255,255,.04);
      opacity:1;
    }
    .navlink.active{
      border-color: rgba(168,199,255,.35);
      background: rgba(168,199,255,.10);
    }

    .userpill{
      display:flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size: 13px;
      white-space: nowrap;
    }
    .dot{
      width: 8px;
      height: 8px;
      border-radius: 99px;
      background: var(--ok);
      box-shadow: 0 0 0 3px rgba(61,220,151,.15);
    }

    main{
      padding: 10px 0 60px;
    }

    .panel{
      background: rgba(16,20,32,.72);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    /* Flash toasts */
    .toasts{
      position:fixed;
      top: 76px;
      right: 16px;
      z-index: 9999;
      display:flex;
      flex-direction:column;
      gap: 10px;
      width: min(420px, calc(100vw - 32px));
    }
    .toast{
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(18,24,41,.94);
      box-shadow: var(--shadow);
      display:flex;
      gap: 10px;
      align-items:flex-start;
      color: var(--text);
    }
    .toast .badge{
      margin-top: 2px;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      flex: 0 0 auto;
      background: rgba(233,237,247,.45);
    }
    .toast.success .badge{ background: var(--ok); }
    .toast.error .badge{ background: var(--danger); }
    .toast.warning .badge{ background: var(--warn); }
    .toast .msg{
      font-weight: 650;
      font-size: 14px;
      line-height: 1.25;
    }

    /* Small helpers you can reuse */
    .muted{ color: var(--muted); }
    .btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap: 8px;
      padding: 9px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.04);
      color: var(--text);
      font-weight: 650;
      cursor:pointer;
      text-decoration:none;
    }
    .btn:hover{ background: rgba(255,255,255,.07); text-decoration:none; }
    .btn.primary{
      border-color: rgba(168,199,255,.35);
      background: rgba(168,199,255,.14);
    }

    @media (max-width: 720px){
      .topbar{ padding: 12px 14px; }
      .toasts{ top: 68px; }
    }


    /* ---------- Form controls (dark) ---------- */

    input,
    textarea,
    select,
    button {
      font-family: inherit;
      font-size: 14px;
    }

    input[type="text"],
    input[type="number"],
    input[type="email"],
    input[type="url"],
    textarea,
    select {
      background: rgba(18, 24, 41, 0.9);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px 10px;
      outline: none;
    }

    textarea {
      resize: vertical;
    }

    input::placeholder,
    textarea::placeholder {
      color: rgba(233,237,247,.45);
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: rgba(168,199,255,.55);
      box-shadow: 0 0 0 2px rgba(168,199,255,.18);
    }

    /* Select arrow fix (keeps it dark) */
    select {
      appearance: none;
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(233,237,247,.5) 50%),
        linear-gradient(135deg, rgba(233,237,247,.5) 50%, transparent 50%);
      background-position:
        calc(100% - 16px) 50%,
        calc(100% - 11px) 50%;
      background-size: 5px 5px;
      background-repeat: no-repeat;
      padding-right: 28px;
    }

    /* Checkboxes */
    input[type="checkbox"] {
      accent-color: #a8c7ff;
    }

    /* Buttons */
    button {
      background: rgba(255,255,255,.04);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 7px 12px;
      cursor: pointer;
      font-weight: 650;
    }

    button:hover {
      background: rgba(255,255,255,.08);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }


    /* --- Learner lesson blocks: force dark cards --- */
    .lesson-page .card,
    .lesson-page .block,
    .lesson-page .block-card,
    .lesson-page .lesson-block,
    .lesson-page .lesson-block-wrapper,
    .lesson-page .block-wrapper,
    .lesson-page .panel-like {
      background: rgba(18,24,41,.72) !important;
      border: 1px solid rgba(233,237,247,.12) !important;
      color: var(--text) !important;
      box-shadow: 0 12px 34px rgba(0,0,0,.35) !important;
    }

    /* If there is an inner white inset box */
    .lesson-page .card > div,
    .lesson-page .block-card > div {
      background: transparent !important;
    }

    .container.wide {
      max-width: 1400px;
    }


    /* === Global themed form controls === */
    /* Avoid styling checkboxes/radios/range/color/file buttons */
    input:not([type="checkbox"]):not([type="radio"]):not([type="range"]):not([type="color"]):not([type="file"]),
    textarea,
    select {
      width: 100%;
      box-sizing: border-box;

      background: rgba(255, 255, 255, 0.06);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 12px;

      padding: 10px 12px;
      line-height: 1.2;

      outline: none;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    /* Placeholder */
    input::placeholder,
    textarea::placeholder {
      color: rgba(255,255,255,0.45);
    }

    /* Focus ring */
    input:focus,
    textarea:focus,
    select:focus {
      border-color: rgba(123, 184, 255, 0.55);
      box-shadow: 0 0 0 3px rgba(123, 184, 255, 0.18);
    }

    /* Disabled */
    input:disabled,
    textarea:disabled,
    select:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    /* iOS/Safari/Chrome autofill makes inputs yellow/white unless you override */
    input:-webkit-autofill,
    textarea:-webkit-autofill,
    select:-webkit-autofill {
      -webkit-text-fill-color: var(--text) !important;
      box-shadow: 0 0 0px 1000px rgba(16,20,32,0.95) inset !important;
      border: 1px solid var(--border);
    }

    /* Make small inline inputs not blow up layouts */
    .input-inline {
      width: auto;
      display: inline-block;
    }


    /* === Selects / dropdown menus === */
    select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      padding-right: 34px; /* room for arrow */
      background-image:
        linear-gradient(45deg, transparent 50%, rgba(255,255,255,.6) 50%),
        linear-gradient(135deg, rgba(255,255,255,.6) 50%, transparent 50%);
      background-position:
        calc(100% - 18px) 50%,
        calc(100% - 12px) 50%;
      background-size: 6px 6px, 6px 6px;
      background-repeat: no-repeat;
    }

    /* Try to style the dropdown list itself (works in many browsers) */
    select option,
    select optgroup {
      background: #0e1320;
      color: #e7ebff;
    }



    /* Lessons filter bar */
    .lessons-filters,
    .filter-bar,
    .search-row {
      display: grid;
      grid-template-columns: 280px 1fr auto;
      gap: 10px;
      align-items: center;
      margin: 14px 0 18px;
    }

    @media (max-width: 768px) {
      .lessons-filters,
      .filter-bar,
      .search-row {
        grid-template-columns: 1fr;
      }
    }

    /* Make controls same height */
    .lessons-filters input,
    .lessons-filters select,
    .lessons-filters button,
    .filter-bar input,
    .filter-bar select,
    .filter-bar button,
    .search-row input,
    .search-row select,
    .search-row button {
      height: 40px;
    }



    /* Themed pricing card */
    .pricing-card,
    .pricing-box,
    .card.pricing,
    .panel.pricing,
    .pricing-panel {
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
    }

    /* Make text inside inherit theme */
    .pricing-card *,
    .pricing-box *,
    .card.pricing *,
    .panel.pricing *,
    .pricing-panel * {
      color: inherit;
    }

    /* Lighten secondary text */
    .pricing-card .muted,
    .pricing-box .muted {
      color: rgba(255,255,255,0.55);
    }


    /* Lessons filters: make button sit nicely in the 3rd column */
    .lessons-filters button,
    .filter-bar button,
    .search-row button {
      width: auto;
      justify-self: start;
      padding: 0 14px;
    }

    /* If the form is narrow, give it breathing room */
    .lessons-filters,
    .filter-bar,
    .search-row {
      max-width: 920px;
    }

    /* Optional: tighten vertical rhythm (helps the ‚Äúno buffer‚Äù feeling) */
    .lessons-filters input,
    .lessons-filters select,
    .lessons-filters button {
      margin: 0;
    }


    /* base.html */
    .nav-links { display: flex; align-items: center; width: 100%; gap: 12px; }
    .nav-group-main, .nav-group-system { display: flex; align-items: center; gap: 8px; }
    .nav-group-system { margin-left: auto; }
    .nav-author-group {
      display: flex; gap: 6px; background: rgba(255,255,255,0.03);
      padding: 4px; border-radius: 12px; border: 1px solid var(--border);
    }
    .inner-divider { width: 1px; height: 14px; background: var(--border); margin: 0 4px; }
    .nav-divider { opacity: .15; margin: 0 10px; }
    .logout-link { opacity: 0.6; font-size: 12px; margin-left: 4px; }

    @media (max-width: 768px) {
      .nav-links {
        flex-direction: column !important;
        align-items: stretch !important;
        gap: 16px !important;
        padding: 24px !important;
        width: calc(100% - 28px) !important;
      }
      .nav-group-main, .nav-group-system, .nav-author-group {
        flex-direction: column; width: 100%; margin-left: 0;
      }
      .navlink, .nav-pill {
        width: 100%; text-align: center; padding: 14px !important; font-size: 16px !important;
      }
      .nav-divider, .inner-divider { display: none; }
      .highlight-blue { background: var(--link) !important; color: #000 !important; }
      .highlight-green { background: var(--ok) !important; color: #000 !important; }
    }

  </style>


  <style>
    /* Reward burst visuals */
    .toast.reward{
      border-color: rgba(61,220,151,.35);
      box-shadow: 0 14px 40px rgba(0,0,0,.45), 0 0 0 1px rgba(61,220,151,.18) inset;
    }

    .reward-overlay{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 10000;
      overflow: hidden;
    }

    .reward-particle{
      position: absolute;
      left: 50vw;
      top: 50vh;
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: rgba(61,220,151,.95);
      box-shadow: 0 0 12px rgba(61,220,151,.55);
      transform: translate(-50%, -50%) scale(.7);
      opacity: 0;
      animation: popfly 900ms cubic-bezier(.12,.9,.22,1) forwards;
    }

    @keyframes popfly{
      0%   { opacity: 0; transform: translate(-50%, -50%) scale(.7); }
      10%  { opacity: 1; }
      100% { opacity: 0; transform: translate(calc(-50% + var(--dx)), calc(-50% + var(--dy))) scale(1); }
    }


    @keyframes toastpulse{
      0% { transform: scale(1); filter: brightness(1); }
      35% { transform: scale(var(--pulse)); filter: brightness(1.15); }
      100% { transform: scale(1); filter: brightness(1); }
    }


    /* Damage vignette flash */
    @keyframes damageFlash {
        0%   { opacity: 0; }
        15%  { opacity: 1; }
        100% { opacity: 0; }
    }

    .damage-overlay {
        position: fixed;
        inset: 0;
        pointer-events: none;
        /* Ensure it's higher than the background and the main content */
        z-index: 100000;

        /* Vibrant radial gradient */
        background: radial-gradient(circle, transparent 20%, rgba(255, 0, 0, 0.5) 100%);
        box-shadow: inset 0 0 150px rgba(255, 0, 0, 0.7);

        /* This adds a physical red "frame" to the screen */
        border: 12px solid rgba(255, 0, 0, 0.3);

        animation: damageFlash 0.6s ease-out forwards;
    }

  </style>



  <style>
    html, body {
      height: 100%;
    }

    body {
      margin: 0;
      min-height: 100vh;
      background: #070a0f; /* fallback base */
      color: #e7ecf3;
    }

    /* Background gradient layer that always covers the page */
    body::before {
      content: "";
      position: fixed; /* Keep it fixed so it doesn't move when you scroll */
      inset: 0;
      z-index: -1;
      width: 100vw;
      height: 100vh; /* Ensure it covers exactly the viewport */
      background:
        radial-gradient(900px 700px at 70% 20%, rgba(16,185,129,0.18), transparent 60%),
        radial-gradient(800px 600px at 20% 80%, rgba(59,130,246,0.14), transparent 60%),
        linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.00));
      background-color: #070a0f; /* This solid fallback ensures no white space at the bottom */
    }

  </style>

  <style>
    .nav-pill {
      padding: 6px 12px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.92);
      text-decoration: none;
      font-size: 13px;
      white-space: nowrap;
      display: inline-block;
    }
    .nav-pill:hover { background: rgba(255,255,255,0.10); }

    /* --- MOBILE FIXES (Screens smaller than 768px) --- */
    @media (max-width: 768px) {

      /* 1. FIX LOGOUT: Make the entire nav menu scrollable */
      .nav-links {
        max-height: 80vh;           /* Limits height so it doesn't go off-screen */
        overflow-y: auto;           /* Adds the scrollbar when content is long */
        padding-bottom: 40px;       /* Adds space at the very bottom for Logout */
        display: flex;
        flex-direction: column;
        -webkit-overflow-scrolling: touch; /* Smooth scrolling for iOS */
      }

      /* 2. FIX OVERLAP: Stack the "Manage" and "+" buttons vertically */
      .nav-author-group {
        display: flex;
        flex-direction: column;     /* Stacks them instead of wrapping */
        gap: 10px;                  /* Consistent space between buttons */
        padding: 10px 0;
        margin: 10px 0;
        border-top: 1px solid rgba(255,255,255,0.1);
        border-bottom: 1px solid rgba(255,255,255,0.1);
      }

      /* 3. Make the buttons easier to tap on mobile */
      .nav-pill {
        display: block;
        width: 100%;                /* Full width for touch safety */
        text-align: center;
        padding: 12px;
        font-size: 15px;
      }

      /* 4. Hide dividers on mobile to save space */
      .nav-divider, .nav-links span[style*="opacity:.35"] {
        display: none !important;
      }
    }
  </style>

  <style>
    #nav-toggle {
      display: none;
    }

    .nav-hamburger {
      display: none;
      font-size: 22px;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.05);
      cursor: pointer;
    }

    @media (max-width: 768px) {
      /* Show hamburger */
      .nav-hamburger {
        display: block;
      }

      /* Hide nav by default */
      .nav-links {
        display: none;
        position: absolute;
        top: 64px;
        right: 14px;
        flex-direction: column;
        gap: 6px;
        padding: 12px;
        background: rgba(16,20,32,.96);
        border: 1px solid var(--border);
        border-radius: 14px;
        box-shadow: var(--shadow);
        z-index: 100;
        min-width: 220px;
      }

      /* Show when toggled */
      #nav-toggle:checked + .nav-hamburger + .nav-links {
        display: flex;
      }

      /* Make links full-width */
      .nav-links .navlink,
      .nav-links .nav-pill {
        width: 100%;
      }
    }
  </style>


  <style>
    /* */
    /* --- Reward and Streak Visuals --- */
    @keyframes flamePulse {
      0%   { transform: scale(1); filter: drop-shadow(0 0 5px orange); }
      50%  { transform: scale(1.1); filter: drop-shadow(0 0 12px red); }
      100% { transform: scale(1); filter: drop-shadow(0 0 5px orange); }
    }

    .high-streak {
      display: inline-block; /* Essential for transform/scale to work */
      animation: flamePulse 2s infinite ease-in-out;
    }



    .user-dropdown {
      position: relative;
      display: inline-block;
      z-index: 1000;
    }

    .dropdown-menu {
      display: none;
      position: absolute;
      top: calc(100% + 5px); /* Small gap for the 'floating' look */
      right: 0;
      min-width: 200px;

      /* Glassmorphism */
      background: rgba(16, 20, 32, 0.92);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);

      /* Themed Border */
      border: 1px solid rgba(168, 199, 255, 0.2);
      border-radius: 16px;
      box-shadow: 0 15px 45px rgba(0,0,0,0.6), 0 0 20px rgba(168,199,255,0.05);

      padding: 8px;
      overflow: hidden;

      /* Animation */
      animation: dropdownFadeIn 0.2s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes dropdownFadeIn {
      from { opacity: 0; transform: translateY(8px) scale(0.98); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }

    /* The 'Invisible Bridge' for hover safety */
    .user-dropdown::after {
      content: "";
      position: absolute;
      top: 100%;
      left: 0;
      width: 100%;
      height: 15px;
    }

    .user-dropdown:hover .dropdown-menu {
      display: block;
    }

    .dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      border-radius: 10px;
      color: var(--text);
      font-size: 13.5px;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .dropdown-item:hover {
      background: rgba(168, 199, 255, 0.12);
      color: var(--link);
      transform: translateX(4px); /* Subtle 'nudge' on hover */
      text-decoration: none;
    }

  </style>



  {% block head %}{% endblock %}
</head>

<body>

  {% if global_announcement %}
    <div class="announcement-banner">
      {{ global_announcement | safe }}
    </div>
  {% endif %}


  {# Flash messages as toasts #}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}

      {# Persistent container for the MutationObserver #}
      <div id="main-toast-container" class="toasts" aria-live="polite" aria-atomic="true">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, msg in messages %}
              {% set c = (category or "")|lower %}
              {% set cls = "toast" %}
              {% if "error" in c or "danger" in c %}{% set cls = cls ~ " error" %}
              {% elif "success" in c %}{% set cls = cls ~ " success" %}{% endif %}

              <div class="{{ cls }}">
                <div class="badge"></div>
                <div class="msg">{{ msg }}</div>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}
      </div>


    {% endif %}
  {% endwith %}

  <header>
    <div class="topbar">
      <a class="brand" href="{{ url_for('main.app_home') }}">
          <img src="{{ url_for('static', filename='favicon.png') }}"
               style="width: 100px; height: 100px; border-radius: 8px; object-fit: cover;">

          <span>
              {{ brand_display }} (Beta)
              <small class="muted">by Hope students</small>
              <small class="muted">for Hope students</small>
          </span>
      </a>



      <input type="checkbox" id="nav-toggle" />
      <label for="nav-toggle" class="nav-hamburger">‚ò∞</label>

      <nav class="nav-links">
        <div class="nav-group-main">
          <a class="navlink" href="{{ url_for('main.app_home') }}">Home</a>
          <a class="navlink" href="{{ url_for('appui.trivia_page') }}">Trivia</a>
          <a class="navlink" href="{{ url_for('companion.view_garden') }}">Garden</a>

          {% if last_curriculum_code %}
            <a class="navlink" href="{{ url_for('main.curriculum_view', curriculum_code=last_curriculum_code) }}">Continue</a>
          {% else %}
            <a class="navlink" href="{{ url_for('main.lessons_continue') }}">Continue</a>
          {% endif %}
        </div>

        <span class="nav-divider">|</span>

        {% if nav_links and (nav_links.new_lesson or nav_links.new_curriculum or nav_links.author_lessons or nav_links.author_curricula) %}
          <div class="nav-author-group">
            {% if nav_links.author_lessons %}<a href="{{ nav_links.author_lessons }}" class="nav-pill">Lessons</a>{% endif %}
            {% if nav_links.author_curricula %}<a href="{{ nav_links.author_curricula }}" class="nav-pill">Curricula</a>{% endif %}

            <div class="inner-divider"></div>

            {% if nav_links.new_lesson %}<a href="{{ nav_links.new_lesson }}" class="nav-pill highlight-blue">+ Lesson</a>{% endif %}
            {% if nav_links.new_curriculum %}<a href="{{ nav_links.new_curriculum }}" class="nav-pill highlight-green">+ Curriculum</a>{% endif %}
          </div>
        {% endif %}

        <div class="nav-group-system">
          {% if require_subscription %}
            <a class="navlink small" href="{{ url_for('billing.pricing') }}">Pricing</a>
            {% if current_user.is_authenticated %}
              <a class="navlink small" href="{{ url_for('billing.portal') }}">Manage</a>
            {% endif %}
          {% endif %}

          <a class="navlink small" href="{{ url_for('appui.account') }}" title="Account Settings">‚öôÔ∏è</a>


          {% if current_user.is_authenticated %}


            <div class="user-dropdown">
              <div class="userpill" style="cursor: pointer; transition: border-color 0.2s;">
                  {% if current_user.current_streak > 0 %}
                    <span class="streak-tag {% if current_user.current_streak >= 7 %}high-streak{% endif %}" title="Daily Streak">
                        üî• {{ current_user.current_streak }}
                    </span>
                    <div class="inner-divider"></div>
                  {% endif %}

                  <span id="header-an-balance2" style="font-weight: bold; color: var(--ok);">
                      {{ "%.3f"|format(an_balance_an) }} AN
                  </span>
                  <span style="font-size: 9px; margin-left: 6px; opacity: 0.4; transition: transform 0.2s;">‚ñº</span>
              </div>

              <div class="dropdown-menu">
                  <div style="padding: 6px 14px; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); opacity: 0.6;">Finance</div>
                  <a href="{{ url_for('appui.portfolio') }}" class="dropdown-item">
                    <span style="font-size: 16px;">üìä</span> Portfolio
                  </a>
                  <a href="{{ url_for('appui.public_ledger') }}" class="dropdown-item">
                    <span style="font-size: 16px;">üìú</span> Public Ledger
                  </a>

                  <div style="height: 1px; background: var(--border); margin: 6px 4px;"></div>

                  <div style="padding: 6px 14px; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); opacity: 0.6;">Settings</div>
                  <a href="{{ url_for('appui.account') }}" class="dropdown-item">
                    <span style="font-size: 16px;">‚öôÔ∏è</span> Account Settings
                  </a>
              </div>
            </div>


            <a href="{{ url_for('auth.logout') }}" class="logout-link">Logout</a>
          {% endif %}

          <a class="navlink small" href="{{ url_for('main.thanks_page') }}">Thanks</a>
        </div>
      </nav>




      {% if an_warn %}
        <div class="header-warning-banner">
          {% if an_critical %}
            <strong>‚ö† Low AN:</strong>
          {% else %}
            <strong>Heads up:</strong>
          {% endif %}

          {# This ID must exist exactly once in the DOM #}
          You have <span id="header-an-balance">{{ "%.4f"|format(an_balance_an) }}</span> AN

          {% if not an_critical %}
            (~{{ (an_balance_an)|int }} days of upkeep)
          {% endif %}
        </div>
      {% endif %}


    </div>
  </header>

  <main class="{% block main_class %}container{% endblock %}">
    {% block content %}{% endblock %}
  </main>

  {% block scripts %}{% endblock %}

  <script>
    function rewardFX(ticks){
      const rawTicks = Math.max(0, Number(ticks) || 0);
      if (rawTicks <= 0) return;

      // =========================
      // Tunable parameters (TOP)
      // =========================
      const isMobile = window.innerWidth < 768;
      const T_REF = 40;

      // Chaining: Larger chunks on mobile reduce the number of DOM operations (I'll test with lower chunks)
      const CAP_TICKS_PER_BURST = isMobile ? 15 : 30;

      // Scaling: We use fewer particles on mobile but make them larger (BASE_SIZE)
      const PARTICLES_PER_TICK = isMobile ? 6 : 30;
      const MAX_PARTICLES_PER_BURST = isMobile ? 100 : 1000;

      // Optional within-burst "extra" pop
      const EXTRA_BURST_MIN_TICKS = 80;
      const EXTRA_BURST_TICK_FRACTION = 0.60;
      const EXTRA_BURST_DELAY_MS = 70;

      // Geometry: Smaller radius for mobile viewports to keep effects on-screen
      const BASE_RADIUS = isMobile ? 140 : 220;
      const RADIUS_PER_TICK = isMobile ? 8 : 12;
      const BASE_RADIUS_2 = isMobile ? 100 : 180;
      const RADIUS2_PER_TICK = isMobile ? 6 : 10;
      const ARC_WIDTH_PI = Math.PI * 1.10;

      // Particle size/glow: Larger particles on mobile compensate for lower counts
      const BASE_SIZE = isMobile ? 6 : 3;
      const SIZE_PER_TICK = isMobile ? 0.20 : 0.12;
      const JITTER_BASE = isMobile ? 4 : 2;
      const JITTER_PER_TICK = 0.10;
      const GLOW_BASE = isMobile ? 15 : 10;
      const GLOW_PER_TICK = 0.55;

      // Timing
      const PARTICLE_DURATION_MS = 980;
      const JITTER_DELAY_MS = 120;

      // Wrapped burst chaining
      const WRAP_START_SPACING_MS = isMobile ? 200 : 140;
      const MIN_TOTAL_MS = 850;

      // Label timing
      const LABEL_FADE_IN_MS = 120;
      const LABEL_EXIT_MS = 260;
      const LABEL_HOLD_PAD_MS = 160;

      // Label look
      const LABEL_BASE_FONT = isMobile ? 22 : 18; // Slightly larger text for mobile
      const LABEL_FONT_PER_TICK = 0.35;
      const LABEL_BASE_SCALE = 0.92;
      const LABEL_SCALE_PER_TICK = 0.010;






      // Aura (constant reading shield ‚Äî NOT payout-scaled)
      const AURA_SIZE_PX = 30;
      const AURA_BLUR_PX = 28;
      const AURA_ALPHA = 0.82;
      const AURA_BLOB_COUNT = 10;
      const AURA_WOBBLE_PX = 26;
      const AURA_BACKDROP_BLUR_PX = 7;


      // Wrapped burst palette cycling
      const PALETTE = [
        { r: 61,  gLo: 190, gHi: 245, b: 151 }, // green
        { r: 120, gLo: 170, gHi: 230, b: 255 }, // cyan/blue
        { r: 255, gLo: 175, gHi: 220, b: 120 }, // warm yellow
        { r: 200, gLo: 160, gHi: 220, b: 255 }, // icy
      ];


      // Path to your new sound effect
      const CHIME_URL = "{{ url_for('static', filename='assets/sounds/chime.wav') }}";

      // =========================
      // Helpers
      // =========================
      const clamp01 = (x) => Math.max(0, Math.min(1, x));
      const bursts = Math.max(1, Math.ceil(rawTicks / CAP_TICKS_PER_BURST));

      const totalBurstSpan = (bursts - 1) * WRAP_START_SPACING_MS + PARTICLE_DURATION_MS;

      let labelTotalMs = LABEL_FADE_IN_MS + totalBurstSpan + LABEL_HOLD_PAD_MS + LABEL_EXIT_MS;
      labelTotalMs = Math.max(labelTotalMs, MIN_TOTAL_MS);

      // =========================
      // Overlay + keyframes
      // =========================
      const overlay = document.createElement('div');
      overlay.className = 'reward-overlay'; // <--- ADD THIS LINE
      overlay.style.cssText = `
        position: fixed;
        inset: 0;
        pointer-events: none;
        z-index: 9999;
        overflow: hidden;
      `;
      document.body.appendChild(overlay);

      if (!document.getElementById('rewardFXKeyframes')) {
        const st = document.createElement('style');
        st.id = 'rewardFXKeyframes';
        st.textContent = `
          @keyframes rewardParticle {
            0%   { opacity: 0; transform: translate(-50%, -50%) translate(0,0) scale(1) rotate(0deg); }
            8%   { opacity: 1; }
            70%  { opacity: 1; }
            100% { opacity: 0; transform: translate(-50%, -50%) translate(var(--dx), var(--dy)) scale(0.65) rotate(var(--rot)); }
          }
          .reward-particle{
            position: absolute;
            left: 50vw;
            top: 50vh;
            border-radius: 999px;
            will-change: transform, opacity;
            animation: rewardParticle ${PARTICLE_DURATION_MS}ms cubic-bezier(.12,.9,.22,1) forwards;
          }

          @keyframes rewardLabelHold{
            0%   { opacity: 0; transform: translate(-50%, -50%) scale(.82); filter: blur(2px); }
            10%  { opacity: 1; transform: translate(-50%, -50%) scale(1.02); filter: blur(0px); }
            85%  { opacity: 1; transform: translate(-50%, -50%) scale(1.04); }
            100% { opacity: 0; transform: translate(-50%, calc(-50% - 18px)) scale(1.08); }
          }
        `;
        document.head.appendChild(st);
      }

      // =========================
      // Label + Wrap
      // =========================
      const labelScale = LABEL_BASE_SCALE + LABEL_SCALE_PER_TICK * rawTicks;
      const labelFont  = LABEL_BASE_FONT + Math.round(LABEL_FONT_PER_TICK * rawTicks);

      const labelWrap = document.createElement('div');
      labelWrap.style.cssText = `
        position:absolute; left:50vw; top:50vh;
        transform: translate(-50%, -50%) scale(${labelScale});
        pointer-events:none;
      `;
      overlay.appendChild(labelWrap);

      const label = document.createElement('div');
      label.textContent = `+${Math.round(rawTicks)} ticks`;
      label.style.cssText = `
        position:absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        font-weight: 900;
        letter-spacing: 0.6px;
        color: rgba(255,255,255,0.97);
        font-size: ${labelFont}px;
        opacity: 0;
        white-space: nowrap;
        animation: rewardLabelHold ${labelTotalMs}ms cubic-bezier(.12,.9,.22,1) forwards;
        z-index: 3;
      `;
      labelWrap.appendChild(label);

      // =========================
      // NEW: Darkening aura behind everything (kills background text bleed)
      // =========================

      // independent size (NOT tied to AURA_SIZE_PX)
      const DARK_SHIELD_SIZE_PX = 200;     // try 360‚Äì520
      const DARK_SHIELD_BLUR_PX = 16;      // soft edge (try 16‚Äì30)

      // opacity tuning (stronger in center)
      const DARK_CENTER_ALPHA = 0.85;      // try 0.70‚Äì0.85
      const DARK_MID_ALPHA = 0.40;         // try 0.18‚Äì0.40

      // ‚Äúfades faster than colored aura‚Äù
      const DARK_INNER_STOP = 0.18;
      const DARK_MID_STOP   = 0.42;
      const DARK_OUTER_STOP = 0.62;



      // === OPTIMIZED DARK SHIELD ===
      const darkBacker = document.createElement('div');
      darkBacker.className = 'dark-shield'; // Add class for easier cleanup
      darkBacker.style.cssText = `
        position:absolute;
        left: 50%; top: 50%;
        transform: translate(-50%, -50%);
        width: 200px; height: 200px;
        border-radius: 999px;
        pointer-events:none;
        opacity: 0;
        z-index: 1;
        background: radial-gradient(circle at 50% 50%,
          rgba(0,0,0,0.85) 0%,
          rgba(0,0,0,0.85) 18%,
          rgba(0,0,0,0.40) 42%,
          rgba(0,0,0,0.00) 62%,
          rgba(0,0,0,0) 100%);
        /* Blur is okay, but keep it modest for mobile */
        filter: blur(${isMobile ? 10 : 16}px);
      `;
      labelWrap.appendChild(darkBacker);



      // Match label duration exactly (same timing as your colored aura)
      darkBacker.animate(
        [
          { opacity: 0 },
          { opacity: 1, offset: 0.08 },
          { opacity: 1, offset: 0.94 },
          { opacity: 0 }
        ],
        { duration: labelTotalMs, easing: 'linear', fill: 'forwards' }
      );


      // =========================
      // Aura (colored, lasts EXACT label duration)
      // =========================
      const backer = document.createElement('div');
      backer.style.cssText = `
        position:absolute;
        left: 50%; top: 50%;
        transform: translate(-50%, -50%);
        width: ${AURA_SIZE_PX}px;
        height: ${AURA_SIZE_PX}px;
        border-radius: 999px;
        pointer-events:none;
        opacity: 0;
        z-index: 2;
        backdrop-filter: blur(${AURA_BACKDROP_BLUR_PX}px);
        -webkit-backdrop-filter: blur(${AURA_BACKDROP_BLUR_PX}px);
      `;
      labelWrap.appendChild(backer);

      const blobs = [];
      for (let i = 0; i < AURA_BLOB_COUNT; i++){
        const b = document.createElement('div');
        b.style.cssText = `
          position:absolute;
          left: 50%; top: 50%;
          transform: translate(-50%, -50%);
          border-radius: 999px;
          mix-blend-mode: screen;
          opacity: 1;
        `;
        backer.appendChild(b);
        blobs.push(b);
      }

      backer.animate(
        [
          { opacity: 0 },
          { opacity: 1, offset: 0.08 },
          { opacity: 1, offset: 0.94 },
          { opacity: 0 }
        ],
        { duration: labelTotalMs, easing: 'linear', fill: 'forwards' }
      );

      function setAuraTint(pal){
        const gMid = Math.round((pal.gLo + pal.gHi) * 0.5);

        label.style.textShadow =
          `0 0 18px rgba(${pal.r},${gMid},${pal.b},0.75),
           0 0 55px rgba(0,0,0,0.78)`;

        for (let i = 0; i < blobs.length; i++){
          const b = blobs[i];
          const frac = 0.70 + (i / Math.max(1, blobs.length - 1)) * 0.65;
          const blobSize = AURA_SIZE_PX * frac;

          const ang = (i * 2.399963229728653) % (Math.PI * 2);
          const wob = (0.35 + 0.65 * (i / Math.max(1, blobs.length-1))) * AURA_WOBBLE_PX;
          const dx = Math.cos(ang) * wob;
          const dy = Math.sin(ang) * wob;

          b.style.width  = `${blobSize}px`;
          b.style.height = `${blobSize}px`;
          b.style.left   = `calc(50% + ${dx.toFixed(1)}px)`;
          b.style.top    = `calc(50% + ${dy.toFixed(1)}px)`;
          b.style.filter = `blur(${(AURA_BLUR_PX * (0.90 + 0.22*i)).toFixed(1)}px)`;

          const a = Math.min(0.45, AURA_ALPHA * (0.85 + 0.18*i));
          b.style.background = `rgba(${pal.r},${gMid},${pal.b},${a})`;
        }
      }

      setAuraTint(PALETTE[0]);
      for (let i = 0; i < bursts; i++){
        const startDelay = i * WRAP_START_SPACING_MS;
        const pal = PALETTE[i % PALETTE.length];
        setTimeout(() => setAuraTint(pal), startDelay);
      }

      // =========================
      // Optimized Particles
      // =========================
      function emitParticles(count, R, intensity, startDelayMs, ticksChunk, paletteIdx){
        const pal = PALETTE[paletteIdx % PALETTE.length];

        // Use a DocumentFragment to minimize browser layout "thrashing"
        const fragment = document.createDocumentFragment();

        // CAP: Prevent more than 400 particles per burst to keep mobile snappy
        const safeCount = Math.min(count, isMobile ? 80 : 400);

        for (let i = 0; i < safeCount; i++){
          const p = document.createElement('div');
          p.className = 'reward-particle';

          const a = (-Math.PI/2) + (Math.random() - 0.5) * ARC_WIDTH_PI;
          const r = (0.18 + 0.82 * Math.random()) * R;
          const dx = Math.cos(a) * r;
          const dy = Math.sin(a) * r;

          p.style.setProperty('--dx', `${dx.toFixed(1)}px`);
          p.style.setProperty('--dy', `${dy.toFixed(1)}px`);
          p.style.setProperty('--rot', `${(Math.random()*540 - 270).toFixed(0)}deg`);

          const base = BASE_SIZE + SIZE_PER_TICK * ticksChunk;
          const s = base + Math.random() * (JITTER_BASE + JITTER_PER_TICK * ticksChunk);
          p.style.width = s.toFixed(1) + 'px';
          p.style.height = s.toFixed(1) + 'px';

          const g = pal.gLo + Math.floor(Math.random() * (pal.gHi - pal.gLo + 1));
          const alpha = 0.62 + Math.random() * 0.38;
          const glow = GLOW_BASE + GLOW_PER_TICK * ticksChunk;

          p.style.background = `rgba(${pal.r}, ${g}, ${pal.b}, ${alpha})`;
          if (!isMobile) {
            p.style.boxShadow = `0 0 ${glow.toFixed(0)}px rgba(${pal.r},${g},${pal.b},${0.22 + intensity * 0.75})`;
          }

          const jitter = Math.random() * JITTER_DELAY_MS;
          p.style.animationDelay = (startDelayMs + jitter).toFixed(0) + 'ms';

          fragment.appendChild(p);
        }
        overlay.appendChild(fragment);
      }


      function spawnBurst(ticksChunk, startDelayMs, paletteIdx){
        const intensity = clamp01(ticksChunk / T_REF);

        const count1 = Math.min(
          MAX_PARTICLES_PER_BURST,
          Math.round(PARTICLES_PER_TICK * ticksChunk)
        );

        const count2 = (ticksChunk >= EXTRA_BURST_MIN_TICKS)
          ? Math.min(MAX_PARTICLES_PER_BURST, Math.round(PARTICLES_PER_TICK * EXTRA_BURST_TICK_FRACTION * ticksChunk))
          : 0;

        const R1 = BASE_RADIUS + RADIUS_PER_TICK * ticksChunk;
        const R2 = BASE_RADIUS_2 + RADIUS2_PER_TICK * ticksChunk;

        emitParticles(count1, R1, intensity, startDelayMs, ticksChunk, paletteIdx);
        if (count2 > 0){
          emitParticles(count2, R2, intensity, startDelayMs + EXTRA_BURST_DELAY_MS, ticksChunk, paletteIdx);
        }
      }

      let remaining = rawTicks;
      for (let i = 0; i < bursts; i++){
        const chunk = Math.min(CAP_TICKS_PER_BURST, remaining);
        remaining -= chunk;

        const startDelay = LABEL_FADE_IN_MS + (i * WRAP_START_SPACING_MS);
        spawnBurst(chunk, startDelay, i);

      }

      setTimeout(() => overlay.remove(), labelTotalMs + 120);
    }

    // Negative feedback FX
    function damageFX() {
        const overlay = document.createElement('div');
        overlay.className = 'damage-overlay';
        document.body.appendChild(overlay);

        // TARGET THE MAIN CONTAINER INSTEAD OF THE BODY
        const mainContent = document.querySelector('main');
        if (mainContent) {
            mainContent.style.transition = 'transform 0.05s';
            mainContent.style.transform = 'translateX(10px)';

            setTimeout(() => { mainContent.style.transform = 'translateX(-10px)'; }, 50);
            setTimeout(() => {
                // Reset transform specifically for the main container
                mainContent.style.transform = 'translateX(0)';
            }, 100);
        }

        setTimeout(() => { overlay.remove(); }, 700);
    }



    document.addEventListener('DOMContentLoaded', () => {
        const toastContainer = document.getElementById('main-toast-container');
        if (!toastContainer) return;

        // 1. Define the Watcher
        const toastObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                mutation.addedNodes.forEach((node) => {
                    // nodeType 1 = Element (ignores whitespace/text nodes)
                    if (node.nodeType === 1 && node.classList.contains('toast')) {
                        console.log("Watcher: Toast Added", node.className);

                        if (node.hasAttribute('data-reward-ticks')) {

                            const chime = new Audio("{{ url_for('static', filename='assets/sounds/chime.wav') }}");
                            chime.volume = 0.35;
                            chime.play().catch(() => {});

                            rewardFX(node.getAttribute('data-reward-ticks'));
                        }
                        if (node.classList.contains('error')) {
                            damageFX();
                        }
                    }
                });
            });
        });

        // 2. Start watching
        toastObserver.observe(toastContainer, { childList: true });

        // 3. Check for initial toasts (using the correct variable name)
        toastContainer.querySelectorAll('.toast').forEach(t => {
            if (t.hasAttribute('data-reward-ticks')) rewardFX(t.getAttribute('data-reward-ticks'));
            if (t.classList.contains('error')) damageFX();
        });
    });

  </script>


</body>

<style>
  /* ---------- MCQ / answer options (radio + checkbox) ---------- */

  /* Make each option row look intentional */
  label:has(input[type="radio"]),
  label:has(input[type="checkbox"]) {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 10px;
    border-radius: 12px;
    border: 1px solid transparent;
    background: rgba(255,255,255,.02);
    cursor: pointer;
    user-select: none;
    max-width: 100%;
  }

  label:has(input[type="radio"]):hover,
  label:has(input[type="checkbox"]):hover {
    background: rgba(255,255,255,.04);
    border-color: rgba(233,237,247,.10);
  }

  /* Make radios/checkboxes match theme */
  input[type="radio"],
  input[type="checkbox"] {
    accent-color: #a8c7ff;
    width: 16px;
    height: 16px;
    margin: 0;
    flex: 0 0 auto;
  }

  /* ‚ÄúSelected‚Äù row treatment */
  label:has(input[type="radio"]:checked),
  label:has(input[type="checkbox"]:checked) {
    background: rgba(168,199,255,.10);
    border-color: rgba(168,199,255,.28);
  }

  /* Text next to the circle */
  label:has(input[type="radio"]) span,
  label:has(input[type="checkbox"]) span {
    color: var(--text);
    line-height: 1.2;
  }
</style>

<style>
  /* ---- Global ‚Äúno harsh white lines‚Äù pass ---- */

  hr{
    border: 0;
    height: 1px;
    margin: 18px 0;
    background: linear-gradient(to right,
      transparent,
      rgba(233,237,247,.10),
      rgba(233,237,247,.16),
      rgba(233,237,247,.10),
      transparent
    );
  }

  /* Any default borders that sneak in */
  *{
    border-color: rgba(233,237,247,.12);
  }

  /* Common offenders */
  iframe{
    border: 1px solid rgba(233,237,247,.14) !important;
    background: rgba(16,20,32,.55);
    border-radius: 14px;
  }

  /* If any template uses <table> later */
  table{
    border-collapse: collapse;
  }
  td, th{
    border-bottom: 1px solid rgba(233,237,247,.10);
  }
</style>

<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

</html>

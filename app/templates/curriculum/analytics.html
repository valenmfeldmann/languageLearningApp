{% extends "base.html" %}
{% block title %}Curriculum Analytics{% endblock %}

{% block content %}
  <div style="display:flex; align-items:baseline; gap:12px;">
    <h1 style="margin:0;">Analytics: {{ curriculum.title }}</h1>
    <a href="{{ url_for('main.curriculum_view', curriculum_code=curriculum.code) }}">View</a>
  </div>

  <p style="opacity:0.75;">
    Lessons in curriculum: {{ summary.lessons_in_curriculum }} |
    Unique lessons: {{ summary.unique_lessons }}
  </p>

  {% if not has_attempt_time %}
    <p style="padding:10px; border:1px solid #ccc; background:#fafafa;">
      Attempt-level time tracking isn’t enabled yet (LessonAttempt.seconds_spent_total missing).
      You’ll still see starts/completions/quiz stats.
    </p>
  {% endif %}

  {% if retention %}
    <h2>Retention</h2>

    <p>
      Median active days (last {{ retention.window_days }}):
      <strong>{{ retention.median_active_days }}</strong>
    </p>

    <form method="get" style="display:flex; gap:12px; align-items:flex-end; flex-wrap:wrap; margin: 8px 0 12px;">
      <div>
        <div style="font-size:12px; opacity:0.7;">Window (days)</div>
        <input type="number" name="window_days" min="1" max="365" value="{{ retention.window_days }}" style="width:90px;">
      </div>

      <div>
        <div style="font-size:12px; opacity:0.7;">Active seconds/day</div>
        <input type="number" name="active_seconds" min="1" max="3600" value="{{ retention.active_seconds }}" style="width:120px;">
      </div>

      <div>
        <div style="font-size:12px; opacity:0.7;">Consistency (0–1)</div>
        <input type="number" name="consistency" min="0" max="1" step="0.01" value="{{ retention.consistency }}" style="width:110px;">
      </div>

      <button type="submit">Update</button>

      <a href="{{ url_for('main.curriculum_analytics', curriculum_code=curriculum.code) }}"
         style="font-size:12px; opacity:0.8; margin-left:8px;">
        reset
      </a>
    </form>


    <p style="display:flex; gap:16px; flex-wrap:wrap; align-items:baseline;">
      <span><strong>{{ retention.user_count }}</strong> users in window</span>
      <span>Active today: <strong>{{ retention.active_today }}</strong></span>
      <span>Active 7d: <strong>{{ retention.active_7d }}</strong></span>
      <span>Active 30d: <strong>{{ retention.active_30d }}</strong></span>
    </p>

    {% set W = 420 %}
    {% set H = 160 %}
    {% set padL = 42 %}
    {% set padR = 10 %}
    {% set padT = 10 %}
    {% set padB = 28 %}
    {% set plotW = W - padL - padR %}
    {% set plotH = H - padT - padB %}
    {% set npts = retention.curve|length %}

    <svg viewBox="0 0 {{ W }} {{ H }}" width="{{ W }}" height="{{ H }}" style="border:1px solid #ccc;">
      {# Axes #}
      <line x1="{{ padL }}" y1="{{ padT }}" x2="{{ padL }}" y2="{{ padT + plotH }}" stroke="black" stroke-width="1"/>
      <line x1="{{ padL }}" y1="{{ padT + plotH }}" x2="{{ padL + plotW }}" y2="{{ padT + plotH }}" stroke="black" stroke-width="1"/>

      {# Y ticks: 0, 25, 50, 75, 100% #}
      {% for pct in [0,25,50,75,100] %}
        {% set y = padT + plotH - (pct/100.0)*plotH %}
        <line x1="{{ padL-4 }}" y1="{{ y }}" x2="{{ padL }}" y2="{{ y }}" stroke="black" stroke-width="1"/>
        <text x="{{ padL-6 }}" y="{{ y+4 }}" font-size="10" text-anchor="end">{{ pct }}%</text>
      {% endfor %}

      {# X ticks: start, mid, end (days ago) #}
      {% set mid = (retention.window_days // 2) %}
      {% for d in [retention.window_days, mid, 1] %}
        {% set x = padL + ((retention.window_days - d) / (retention.window_days - 1 if retention.window_days>1 else 1)) * plotW %}
        <line x1="{{ x }}" y1="{{ padT + plotH }}" x2="{{ x }}" y2="{{ padT + plotH + 4 }}" stroke="black" stroke-width="1"/>
        <text x="{{ x }}" y="{{ padT + plotH + 16 }}" font-size="10" text-anchor="middle">{{ d }}d</text>
      {% endfor %}

      {# Axis labels #}
      <text x="{{ padL + plotW/2 }}" y="{{ H-6 }}" font-size="11" text-anchor="middle">Lookback window (days)</text>
      <text x="12" y="{{ padT + plotH/2 }}" font-size="11" text-anchor="middle"
            transform="rotate(-90 12 {{ padT + plotH/2 }})">% of users meeting consistency</text>

      {# Curve as connected line segments #}
      {% for v in retention.curve %}
        {% set i = loop.index0 %}
        {% if i > 0 %}
          {% set x1 = padL + ((i-1) / (npts-1 if npts>1 else 1)) * plotW %}
          {% set y1 = padT + plotH - (retention.curve[i-1] * plotH) %}
          {% set x2 = padL + (i / (npts-1 if npts>1 else 1)) * plotW %}
          {% set y2 = padT + plotH - (v * plotH) %}
          <line x1="{{ x1 }}" y1="{{ y1 }}" x2="{{ x2 }}" y2="{{ y2 }}" stroke="black" stroke-width="2"/>
        {% endif %}
      {% endfor %}


      {# Loose curve: dashed #}
      {% for v in retention.loose_curve %}
        {% set i = loop.index0 %}
        {% if i > 0 %}
          <line
            x1="{{ (i-1) * 300 / retention.loose_curve|length }}"
            y1="{{ 100 - (retention.loose_curve[i-1] * 100) }}"
            x2="{{ i * 300 / retention.loose_curve|length }}"
            y2="{{ 100 - (v * 100) }}"
            stroke="black"
            stroke-width="2"
            stroke-dasharray="4 3"
            opacity="0.7"
          />
        {% endif %}
      {% endfor %}

    </svg>

    <p style="opacity:0.7; font-size:12px; margin-top:6px;">
      <span style="white-space:nowrap;">— Strict: ≥ {{ (retention.consistency * 100)|round(0) }}% of days active</span>
      &nbsp;&nbsp;|&nbsp;&nbsp;
      <span style="white-space:nowrap;">– – Loose: ≥ 1 active day in last n days</span>
    </p>


    <p style="opacity:0.7; font-size:12px;">
      Active = ≥ {{ retention.active_seconds }}s/day,
      Consistency ≥ {{ (retention.consistency * 100)|round(0) }}%
    </p>

    {% if funnel %}
      <h2>Curriculum funnel (last {{ funnel.window_days }}d)</h2>
      <p style="opacity:0.8;">Cohort size: <strong>{{ funnel.denominator }}</strong></p>

      {# simple 2-line chart: reached vs completed #}
      {% set W = 520 %}
      {% set H = 160 %}
      {% set padL = 42 %}
      {% set padR = 10 %}
      {% set padT = 10 %}
      {% set padB = 28 %}
      {% set plotW = W - padL - padR %}
      {% set plotH = H - padT - padB %}
      {% set npts = funnel.reached|length %}

      <svg viewBox="0 0 {{ W }} {{ H }}" width="{{ W }}" height="{{ H }}" style="border:1px solid #ccc;">
        <line x1="{{ padL }}" y1="{{ padT }}" x2="{{ padL }}" y2="{{ padT + plotH }}" stroke="black" stroke-width="1"/>
        <line x1="{{ padL }}" y1="{{ padT + plotH }}" x2="{{ padL + plotW }}" y2="{{ padT + plotH }}" stroke="black" stroke-width="1"/>

        {% for pct in [0,25,50,75,100] %}
          {% set y = padT + plotH - (pct/100.0)*plotH %}
          <line x1="{{ padL-4 }}" y1="{{ y }}" x2="{{ padL }}" y2="{{ y }}" stroke="black" stroke-width="1"/>
          <text x="{{ padL-6 }}" y="{{ y+4 }}" font-size="10" text-anchor="end">{{ pct }}%</text>
        {% endfor %}

        <text x="{{ padL + plotW/2 }}" y="{{ H-6 }}" font-size="11" text-anchor="middle">Slot #</text>
        <text x="12" y="{{ padT + plotH/2 }}" font-size="11" text-anchor="middle"
              transform="rotate(-90 12 {{ padT + plotH/2 }})">% of cohort</text>

        {# reached: solid #}
        {% for v in funnel.reached %}
          {% set i = loop.index0 %}
          {% if i > 0 %}
            {% set x1 = padL + ((i-1) / (npts-1 if npts>1 else 1)) * plotW %}
            {% set y1 = padT + plotH - (funnel.reached[i-1] * plotH) %}
            {% set x2 = padL + (i / (npts-1 if npts>1 else 1)) * plotW %}
            {% set y2 = padT + plotH - (v * plotH) %}
            <line x1="{{ x1 }}" y1="{{ y1 }}" x2="{{ x2 }}" y2="{{ y2 }}" stroke="black" stroke-width="2"/>
          {% endif %}
        {% endfor %}

        {# completed: dashed #}
        {% for v in funnel.completed %}
          {% set i = loop.index0 %}
          {% if i > 0 %}
            {% set x1 = padL + ((i-1) / (npts-1 if npts>1 else 1)) * plotW %}
            {% set y1 = padT + plotH - (funnel.completed[i-1] * plotH) %}
            {% set x2 = padL + (i / (npts-1 if npts>1 else 1)) * plotW %}
            {% set y2 = padT + plotH - (v * plotH) %}
            <line x1="{{ x1 }}" y1="{{ y1 }}" x2="{{ x2 }}" y2="{{ y2 }}"
                  stroke="black" stroke-width="2" stroke-dasharray="4 3" opacity="0.7"/>
          {% endif %}
        {% endfor %}
      </svg>

      <p style="opacity:0.7; font-size:12px; margin-top:6px;">
        — Reached (started) &nbsp; | &nbsp; – – Completed
      </p>

      <table border="1" cellpadding="6" cellspacing="0" style="width:100%; max-width:720px; margin-top:10px;">
        <thead>
          <tr>
            <th style="width:60px;">Slot</th>
            <th style="width:120px;">Reached %</th>
            <th style="width:140px;">Completed %</th>
            <th>Dropoff to next</th>
          </tr>
        </thead>
        <tbody>
          {% for r in funnel.reached %}
            {% set i = loop.index0 %}
            <tr>
              <td style="text-align:center;">{{ i+1 }}</td>
              <td style="text-align:right;">{{ (100*r)|round(1) }}%</td>
              <td style="text-align:right;">{{ (100*funnel.completed[i])|round(1) }}%</td>
              <td style="text-align:right;">
                {% if funnel.dropoff[i] is none %}
                  —
                {% else %}
                  {{ (100*funnel.dropoff[i])|round(1) }}%
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    {% endif %}


  {% endif %}

  {% if rows and rows|length > 0 %}
    <table border="1" cellpadding="8" cellspacing="0" style="width:100%; max-width:1100px;">
      <thead>
        <tr>
          <th style="width:60px;">Slot</th>
          <th>Lesson</th>
          <th style="width:90px;">Starts</th>
          <th style="width:110px;">Completions</th>
          <th style="width:120px;">Completion %</th>
          <th style="width:120px;">Avg time</th>
          <th style="width:140px;">Quiz accuracy</th>
          <th>Note</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
          <tr>
            <td style="text-align:center;">{{ r.slot }}</td>
            <td>
              <div><a href="{{ url_for('main.lesson_page', lesson_code=r.lesson_code, curriculum=curriculum.code) }}">{{ r.lesson_title }}</a></div>
              <div style="opacity:0.65; font-size:12px;">{{ r.lesson_code }}</div>
            </td>
            <td style="text-align:right;">{{ r.starts }}</td>
            <td style="text-align:right;">{{ r.completions }}</td>
            <td style="text-align:right;">
              {% if r.completion_rate is not none %}
                {{ (100 * r.completion_rate) | round(1) }}%
              {% else %}
                —
              {% endif %}
            </td>
            <td style="text-align:right;">
              {% if r.avg_seconds is not none %}
                {{ (r.avg_seconds / 60.0) | round(1) }} min
              {% else %}
                —
              {% endif %}
            </td>
            <td style="text-align:right;">
              {% if r.quiz_blocks == 0 %}
                —
              {% elif r.quiz_accuracy is not none %}
                {{ (100 * r.quiz_accuracy) | round(1) }}%
                <div style="opacity:0.65; font-size:12px;">
                  ({{ r.quiz_answered_rows }} answered rows)
                </div>
              {% else %}
                —
              {% endif %}
            </td>
            <td>{{ r.note or "" }}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  {% else %}
    <p style="opacity:0.8; font-style:italic;">No lesson items found in this curriculum.</p>
  {% endif %}
{% endblock %}

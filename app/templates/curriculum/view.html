{% extends "base.html" %}
{% block title %}{{ curriculum.title }}{% endblock %}

{% block content %}
  <div style="display:flex; align-items:baseline; gap: 12px;">
    <h1 style="margin:0;">{{ curriculum.title }}</h1>
    <a href="{{ url_for('main.curriculum_index') }}" style="font-size: 14px;">← all curriculums</a>

    {% if can_manage %}
      <form method="post" action="{{ url_for('main.payout_curriculum', curriculum_code=curriculum.code) }}"
            style="display:inline;">
        <button type="submit">Payout now</button>
      </form>
    {% endif %}

    {% if can_view_analytics %}
      <a href="{{ url_for('main.curriculum_analytics', curriculum_code=curriculum.code) }}">Analytics</a>
    {% endif %}

    {% if can_edit %}
      <a href="{{ url_for('author.curriculum_edit', curriculum_id=curriculum.id) }}">Edit</a>
    {% endif %}
  </div>

  {% if curriculum.description %}
    <p style="opacity:0.85; margin-top: 10px;">{{ curriculum.description }}</p>
  {% endif %}

  <!-- Trading UI -->
  <div style="margin-top: 18px; padding: 12px; border: 1px solid #ddd; border-radius: 8px;">
    <h3 style="margin: 0 0 10px 0;">Trade curriculum shares</h3>

    <div style="opacity:0.85; margin-bottom: 10px;">
      <div>Your balance: <b>{{ my_an_ticks / AN_SCALE }}</b> AN</div>
      <div>Your shares: <b>{{ my_shares }}</b></div>
      <div>Curriculum treasury: <b>{{ curriculum_an_ticks / AN_SCALE }}</b> AN</div>
      <div>Total shares outstanding: <b>{{ total_shares_outstanding }}</b></div>
      <div>Your ownership: <b>{{ ownership_pct | round(2) }}%</b></div>
    </div>

    <div style="display:flex; gap: 16px; flex-wrap: wrap; align-items:flex-start;">
      <!-- Place order form -->
      <div style="min-width: 320px;">
        <form method="post" action="{{ url_for('main.place_curriculum_order', curriculum_code=curriculum.code) }}">
          <div style="display:flex; gap: 10px; align-items:center; flex-wrap: wrap;">
            <label>Side
              <select name="side">
                <option value="bid">Bid (buy shares)</option>
                <option value="ask">Ask (sell shares)</option>
              </select>
            </label>

            <label>Price (AN/share)
              <input name="price_an" type="number" step="0.001" min="0.001" required style="width: 120px;">
            </label>

            <label>Qty (shares)
              <input name="qty" type="number" step="1" min="1" required style="width: 100px;">
            </label>

            <button type="submit">Place order</button>
          </div>
          <div style="font-size: 12px; opacity:0.7; margin-top: 6px;">
            1 AN = {{ AN_SCALE }} ticks. Orders escrow funds/shares immediately.
          </div>
        </form>
      </div>

      <!-- My open orders -->
      <div style="min-width: 360px;">
        <div style="font-weight: 600; margin-bottom: 6px;">My open orders</div>
        {% if my_open_orders %}
          <table style="border-collapse: collapse; width: 100%;">
            <tr style="text-align:left; border-bottom:1px solid #ddd;">
              <th style="padding:6px;">Side</th>
              <th style="padding:6px;">Price (AN)</th>
              <th style="padding:6px;">Remaining</th>
              <th style="padding:6px;"></th>
            </tr>
            {% for o in my_open_orders %}
              <tr style="border-bottom:1px solid #eee;">
                <td style="padding:6px;">{{ o.side }}</td>
                <td style="padding:6px;">{{ (o.price_ticks / AN_SCALE) }}</td>
                <td style="padding:6px;">{{ o.qty_remaining }}</td>
                <td style="padding:6px;">
                  <form method="post" action="{{ url_for('main.cancel_order', order_id=o.id) }}">
                    <button type="submit">Cancel</button>
                  </form>
                </td>
              </tr>
            {% endfor %}
          </table>
        {% else %}
          <div style="opacity:0.75;">No open orders.</div>
        {% endif %}
      </div>
    </div>

    <!-- Order book -->
    <div style="display:flex; gap: 24px; margin-top: 14px; flex-wrap: wrap;">
      <div style="min-width: 360px;">
        <div style="font-weight: 600; margin-bottom: 6px;">Bids (buyers)</div>
        {% if bids %}
          <table style="border-collapse: collapse; width: 100%;">
            <tr style="text-align:left; border-bottom:1px solid #ddd;">
              <th style="padding:6px;">Price (AN)</th>
              <th style="padding:6px;">Qty</th>
              <th style="padding:6px;">User</th>
            </tr>
            {% for o in bids %}
              <tr style="border-bottom:1px solid #eee;">
                <td style="padding:6px;">{{ (o.price_ticks / AN_SCALE) }}</td>
                <td style="padding:6px;">{{ o.qty_remaining }}</td>
                <td style="padding:6px;">{{ o.user_id[:8] }}…</td>
              </tr>
            {% endfor %}
          </table>
        {% else %}
          <div style="opacity:0.75;">No bids.</div>
        {% endif %}
      </div>

      <div style="min-width: 360px;">
        <div style="font-weight: 600; margin-bottom: 6px;">Asks (sellers)</div>
        {% if asks %}
          <table style="border-collapse: collapse; width: 100%;">
            <tr style="text-align:left; border-bottom:1px solid #ddd;">
              <th style="padding:6px;">Price (AN)</th>
              <th style="padding:6px;">Qty</th>
              <th style="padding:6px;">User</th>
            </tr>
            {% for o in asks %}
              <tr style="border-bottom:1px solid #eee;">
                <td style="padding:6px;">{{ (o.price_ticks / AN_SCALE) }}</td>
                <td style="padding:6px;">{{ o.qty_remaining }}</td>
                <td style="padding:6px;">{{ o.user_id[:8] }}…</td>
              </tr>
            {% endfor %}
          </table>
        {% else %}
          <div style="opacity:0.75;">No asks.</div>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- Existing curriculum content -->
  <div style="margin-top: 18px;">
    <ol style="padding-left: 22px;">
      {% for it in items %}
        {% if it.kind == "phase" %}
          <li style="margin: 16px 0 8px; list-style: none; padding-left: 0;">
            <h3 style="margin: 0;">{{ it.title }}</h3>
          </li>

        {% elif it.kind == "lesson" %}
          <li style="margin: 8px 0;">
            {% if it.is_done %}
              <span title="Completed" aria-label="Completed">✅</span>
            {% else %}
              <span title="Not completed yet" aria-label="Not completed yet">⬜</span>
            {% endif %}

            {% if it.lesson %}
              <a href="{{ url_for('main.lesson_page',
                                  lesson_code=it.lesson.code,
                                  src='curriculum_view',
                                  q=curriculum.code,
                                  curriculum=curriculum.code,
                                  pos=loop.index0) }}"
                 style="margin-left: 8px;">
                {{ it.lesson.title }}
              </a>
              <span style="opacity:0.65; margin-left: 8px; font-size: 12px;">
                (attempt {{ it.occurrence }})
              </span>
            {% else %}
              <span style="margin-left: 8px; opacity:0.8; font-style: italic;">
                Missing lesson (deleted?)
              </span>
            {% endif %}

            {% if it.note %}
              <div style="margin-left: 28px; margin-top: 4px; opacity:0.85;">
                {{ it.note }}
              </div>
            {% endif %}
          </li>

        {% else %}
          <li style="margin: 8px 0; opacity:0.8; font-style: italic;">
            Unknown curriculum item
          </li>
        {% endif %}
      {% endfor %}
    </ol>
  </div>
{% endblock %}

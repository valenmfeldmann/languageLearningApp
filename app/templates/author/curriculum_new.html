{% extends "base.html" %}
{% block title %}New Curriculum{% endblock %}

{% block content %}
  <h1>Create curriculum</h1>

  <form method="POST" action="{{ url_for('author.curriculum_new_post') }}">

    <div style="margin: 10px 0;">
      <label style="font-weight: 700;">Title</label><br>
      <input type="text" id="title-input" name="title" required
             placeholder="Spanish Week 1"
             style="width: 420px; max-width: 100%; font-size: 1.1rem; padding: 10px;">
    </div>

    <div style="margin: 10px 0; opacity: 0.75;">
      <label style="font-size: 12px; color: var(--muted);">URL Slug (autogenerated)</label><br>
      <input type="text" id="code-input" name="code" required
             placeholder="spanish-week-1"
             style="width: 420px; max-width: 100%; border-style: dashed; font-size: 13px; font-family: monospace;">
    </div>



    <label>Subject</label>
    <select name="subject_code" class="dark-field" required>
      <option value="">— Select subject —</option>
      {% for s in subjects %}
        <option value="{{ s.code }}">{{ s.name }}</option>
      {% endfor %}
    </select>

    <label style="display:block; margin-top: 10px;">School</label>
    <select name="school_code" class="dark-field" required>
      <option value="">— Select school —</option>
      {% for sc in schools %}
        <option value="{{ sc.code }}">{{ sc.name }}</option>
      {% endfor %}
    </select>



    <div style="margin: 10px 0;">
      <label>Description (optional)</label><br>
      <textarea name="description" rows="3" style="width: 620px; max-width: 100%;"></textarea>
    </div>

    <div style="margin-top: 14px;">
      <button type="submit">Create</button>
      <a href="{{ url_for('author.import_form') }}" style="margin-left: 10px;">Author home</a>
    </div>
  </form>


<script>
  document.addEventListener('DOMContentLoaded', () => {
    const titleInput = document.getElementById('title-input');
    const codeInput = document.getElementById('code-input');

    if (!titleInput || !codeInput) return; // Safety check

    let manualEdit = false;
    const suffix = Math.random().toString(16).substring(2, 6);

    codeInput.addEventListener('input', () => { manualEdit = true; });

    titleInput.addEventListener('input', () => {
      if (manualEdit) return;

      const baseSlug = titleInput.value
        .toLowerCase()
        .trim()
        .replace(/[\s_]+/g, '-')
        .replace(/[^\w\-]+/g, '')
        .replace(/\-\-+/g, '-')
        .replace(/^-+/, '')
        .replace(/-+$/, '');

      // Only append suffix if there is actual text in the slug
      codeInput.value = baseSlug ? `${baseSlug}-${suffix}` : '';
    });
  });
</script>

{% endblock %}

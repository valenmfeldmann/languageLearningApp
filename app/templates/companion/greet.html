{% extends "base.html" %}

{# Redefine or Import the Macro #}
{% macro render_media(url, alt_text="", style="", classes="", is_video=True) %}
    {% set ext = url.split('.')[-1].lower() if '.' in url else '' %}
    {% if ext in ['mp4', 'webm'] or (ext == '' and is_video) %}
        <video src="{{ url }}" style="{{ style }}" class="{{ classes }}"
               autoplay loop muted playsinline preload="auto"></video>
    {% else %}
        <img src="{{ url }}" alt="{{ alt_text }}" style="{{ style }}" class="{{ classes }}">
    {% endif %}
{% endmacro %}

{% block head %}
{# Only auto-redirect if it's a normal greeting. #}
{% if not is_transition %}
<meta http-equiv="refresh" content="4.5;url={{ url_for('main.app_home') }}">
{% endif %}
{% endblock %}

{% block content %}
<div style="max-width: 600px; margin: 80px auto; text-align: center; padding: 24px;">

    {% if is_transition %}
        <div style="margin-bottom: 40px; animation: fadeIn 2s ease-in;">
            <div style="width: 100px; height: 100px; margin: 0 auto; position: relative; border-radius: 50%; overflow: hidden; border: 2px solid #444; background: #000; opacity: 0.6;">
                {{ render_media(
                    url_for('companion.dog_asset', breed=old_dog.breed_type, expression='death'),
                    style="width: 100%; height: 100%; object-fit: cover; filter: grayscale(100%);",
                    is_video=True
                ) }}
            </div>
            <p style="margin-top: 15px; color: var(--muted); font-style: italic;">
                While you were away, {{ old_dog.name }} passed peacefully. âœ¦
            </p>
        </div>
    {% endif %}


    <div style="position: relative; margin-bottom: 40px; display: inline-block; width: 100%; max-width: 500px; animation: float 3s ease-in-out infinite;">
        <div style="background: rgba(168, 199, 255, 0.08); border: 1px solid rgba(168, 199, 255, 0.3); padding: 30px; border-radius: 24px; position: relative; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">

            <p style="font-size: 1.6rem; color: #fff; line-height: 1.4; margin: 0; font-family: 'serif'; font-style: italic;">
                "{{ companion_speech }}"
            </p>

            {# Tail now points DOWN toward the avatar #}
            <div style="position: absolute; bottom: -12px; left: 50%; transform: translateX(-50%); width: 0; height: 0; border-left: 14px solid transparent; border-right: 14px solid transparent; border-top: 14px solid rgba(168, 199, 255, 0.3);"></div>
        </div>
    </div>

    <div style="width: 260px; height: 260px; margin: 0 auto 15px; border-radius: 50%; overflow: hidden; border: 4px solid var(--link); background: #000; box-shadow: 0 0 40px rgba(168, 199, 255, 0.15);">
        {{ render_media(
            url_for('companion.dog_asset', breed=dog.breed_type, expression=expression),
            alt_text=dog.name,
            style="width: 100%; height: 100%; object-fit: cover;",
            is_video=True
        ) }}
    </div>

    <h1 style="font-size: 1rem; color: var(--muted); font-weight: 400; letter-spacing: 2px; text-transform: uppercase; margin-top: 0; opacity: 0.8;">
        {{ dog.name }}
    </h1>

    <style>
    /* Floating effect for the bubble */
    @keyframes float {
        0% { transform: translateY(0px); }
        50% { transform: translateY(-10px); }
        100% { transform: translateY(0px); }
    }
    </style>


    <div style="margin-top: 40px;">
        <a href="{{ url_for('main.app_home') }}" class="btn primary">Dashboard &rarr;</a>
    </div>


</div>

<script>
    {% if not is_transition %}
    setTimeout(() => {
        window.location.href = "{{ url_for('main.app_home') }}";
    }, 5000);
    {% endif %}
</script>
{% endblock %}
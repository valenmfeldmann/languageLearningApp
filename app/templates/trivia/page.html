{% extends "base.html" %}
{% block content %}

{% from "lessons/macros/typed.html" import render_typed %}

<style>
  .dark-field {
    background: rgba(255,255,255,0.06);
    color: rgba(255,255,255,0.92);
    border: 1px solid rgba(255,255,255,0.14);
    border-radius: 10px;
    padding: 10px 12px;
    outline: none;
  }
  .dark-field::placeholder { color: rgba(255,255,255,0.38); }
  .dark-field:focus {
    border-color: rgba(120, 200, 255, 0.55);
    box-shadow: 0 0 0 3px rgba(120, 200, 255, 0.12);
  }

  /* GRID & SYMMETRY ENGINE */
  .trivia-grid {
    display: grid;
    gap: 16px;
    margin-top: 20px;
    grid-template-columns: repeat(2, 1fr);
  }

  .choice-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    aspect-ratio: 1 / 1;
    padding: 12px;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.25);
    background: rgba(255,255,255,0.08);
    color: white;
    cursor: pointer;
    overflow: hidden;
    transition: background 0.15s, transform 0.05s, opacity 0.2s;
  }

  .choice-btn:hover { background: rgba(255,255,255,0.16); }
  .choice-btn:active { transform: scale(0.98); }

  .choice-btn img, .choice-btn video {
    width: 100% !important;
    height: 100% !important;
    max-height: 75% !important;
    object-fit: cover !important;
    display: block;
    border-radius: 10px;
    margin-bottom: 8px;
  }

  .choice-btn div, .choice-btn span {
    margin-top: auto;
    font-size: 0.95rem;
    font-weight: 600;
  }

  @media (max-width: 500px) {
    .trivia-grid { gap: 10px; }
    .choice-btn { padding: 8px; }
  }
</style>

<div style="max-width: 760px; margin: 0 auto; padding: 24px;">
  <h1>Trivia</h1>

  <form method="get" action="{{ url_for('appui.trivia_page') }}"
        style="display:flex; gap:8px; margin: 12px 0; flex-wrap:wrap; align-items:center;">
    <select name="subject" class="dark-field">
      <option value="">All subjects</option>
      {% for s in subjects %}
        <option value="{{ s.code }}" {% if subject_code == s.code %}selected{% endif %}>
          {{ s.name }}
        </option>
      {% endfor %}
    </select>
    <input name="q" value="{{ q or '' }}" placeholder="Search..." class="dark-field">
    <button class="dark-btn" type="submit">Search</button>
  </form>

  <div id="trivia-card-container">
    {% if not block %}
      <p>No trivia question available.</p>
    {% else %}
      <div id="active-trivia-card" style="
        border: 1px solid rgba(255,255,255,0.15);
        border-radius: 16px;
        padding: 24px;
        background: rgba(0,0,0,0.45);
        box-shadow: 0 20px 40px rgba(0,0,0,0.35);
      ">
        <div style="opacity: 0.65; font-size: 13px; margin-bottom: 14px;">
          Source: <b>{{ lesson.title }}</b> ({{ lesson.code }})
        </div>

        <div style="font-size: 22px; line-height: 1.4; font-weight: 500; color: #ffffff; margin-bottom: 20px;">
          {{ render_typed(block.payload_json.get("prompt", ""), lesson.id) }}
        </div>

        <form method="post" action="{{ url_for('appui.trivia_answer') }}" class="trivia-grid">
          <input type="hidden" name="block_id" value="{{ block.id }}">
          <input type="hidden" name="subject" value="{{ subject_code or '' }}">
          <input type="hidden" name="q" value="{{ q or '' }}">
          {% for c in block.payload_json.get("choices", []) %}
            <button type="button" class="choice-btn" name="choice_index" value="{{ loop.index0 }}">
              {{ render_typed(c, lesson.id) }}
            </button>
          {% endfor %}
        </form>

        <form method="post" action="{{ url_for('appui.trivia_bad_vote') }}" style="margin-top: 14px;">
          <input type="hidden" name="block_id" value="{{ block.id }}">
          <button type="submit" style="padding: 8px 12px; border-radius: 10px; border: 1px solid #a44; background: rgba(120,20,20,0.15); color: #ffb3b3; font-size: 13px; cursor: pointer;">
            Vote: bad question
          </button>
        </form>
      </div>
    {% endif %}
  </div>

  <div id="trivia-buffer" style="display: none;"></div>
</div>

{% endblock %}

{% block scripts %}
<script>
  let bufferReady = false;

  async function preloadNextQuestion() {
    bufferReady = false;
    try {
      const response = await fetch(window.location.href);
      const html = await response.text();
      const doc = new DOMParser().parseFromString(html, 'text/html');
      const nextCard = doc.getElementById('active-trivia-card');
      if (nextCard) {
        document.getElementById('trivia-buffer').innerHTML = nextCard.innerHTML;
        bufferReady = true;
      }
    } catch (err) { console.error("Preload fail", err); }
  }

  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.choice-btn');
    if (!btn) return;

    e.preventDefault();

    // 1. LOCK ONLY ACTIVE BUTTONS
    // We target only buttons inside the active card so we don't accidentally
    // disable the pre-loaded buttons in the background buffer.
    const activeBtns = document.querySelectorAll('#active-trivia-card .choice-btn');
    activeBtns.forEach(b => {
      b.style.pointerEvents = 'none';
      b.style.opacity = '0.4';
    });

    const form = btn.closest('form');
    const formData = new FormData(form);
    formData.set('choice_index', btn.value);

    try {
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: { 'X-Requested-With': 'XMLHttpRequest' }
      });
      const result = await response.json();

      // 2. Feedbacks & Balance Updates
      if (result.is_correct && typeof rewardFX === 'function') {
        rewardFX(result.payout);
      }

      ['header-an-balance', 'header-an-balance2'].forEach(id => {
        const el = document.getElementById(id);
        if (el && result.new_balance_an) el.textContent = result.new_balance_an;
      });

      // 3. Swap and Clean up
      // 400ms delay ensures the user sees the confetti/glow before the swap
      setTimeout(() => {
        const activeCard = document.getElementById('active-trivia-card');
        const buffer = document.getElementById('trivia-buffer');

        // AGGRESSIVE CLEANUP: Remove any dimming overlays from base.html
        document.querySelectorAll('.reward-overlay').forEach(el => el.remove());

        if (bufferReady && buffer.innerHTML.trim() !== "") {
          activeCard.innerHTML = buffer.innerHTML;
          buffer.innerHTML = "";

          // Play audio for the new question
          const newAudio = activeCard.querySelector('audio');
          if (newAudio) {
            setTimeout(() => newAudio.play().catch(() => {}), 50);
          }

          preloadNextQuestion();
        } else {
          window.location.reload();
        }
      }, 450);

    } catch (err) { window.location.reload(); }
  });

  window.addEventListener('DOMContentLoaded', () => {
    preloadNextQuestion();
    const firstAudio = document.querySelector('#active-trivia-card audio');
    if (firstAudio) firstAudio.play().catch(() => {});
  });
</script>
{% endblock %}
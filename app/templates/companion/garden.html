{% extends "base.html" %}

{% macro render_media(url, alt_text="", style="", classes="", is_video=True) %}
    {# If the URL has an extension, use it. Otherwise, rely on the is_video flag. #}
    {% set ext = url.split('.')[-1].lower() if '.' in url else '' %}

    {% if ext in ['mp4', 'webm'] or (ext == '' and is_video) %}
        <video src="{{ url }}"
               style="{{ style }}"
               class="{{ classes }}"
               autoplay loop muted playsinline
               preload="auto"
               onerror="console.error('Video failed:', this.src)">
        </video>
    {% else %}
        <img src="{{ url }}" alt="{{ alt_text }}" style="{{ style }}" class="{{ classes }}"
             onerror="console.error('Image failed:', this.src)">
    {% endif %}
{% endmacro %}


{% block content %}
<div class="container" style="padding: 40px 20px; max-width: 1000px; margin: 0 auto;">
    
    <div style="display: flex; align-items: center; gap: 30px; margin-bottom: 50px; background: rgba(255,255,255,0.03); padding: 30px; border-radius: 20px; border: 1px solid rgba(255,255,255,0.05);">


        <div style="width: 120px; height: 120px; border-radius: 50%; border: 3px solid var(--link); overflow: hidden; background: #000;">


            {{ render_media(
                url_for('companion.dog_asset', breed=dog.breed_type, expression='content'),
                alt_text=dog.name,
                style="width: 100%; height: 100%; object-fit: cover;",
                is_video=True
            ) }}


        </div>

        <div>
            <h1 style="margin: 0; font-size: 2.2rem;">{{ dog.name }}'s Sanctuary</h1>
            <p style="color: var(--muted); margin-top: 5px; font-size: 1.1rem;">A peaceful place grown with your AN.</p>
        </div>
    </div>


    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 25px;">
        {% for item in items %}
        <div class="card" style="text-align: center; padding: 25px; background: rgba(255,255,255,0.05); border-radius: 15px; transition: transform 0.2s;">
            <div style="height: 140px; display: flex; align-items: center; justify-content: center; margin-bottom: 15px;">


                <div style="height: 140px; display: flex; overflow: hidden; border-radius: 12px; align-items: center; justify-content: center; margin-bottom: 15px;">


                    {{ render_media(
                        url_for('companion.plant_asset', identifier=item.plant.identifier, level=item.level),
                        alt_text=item.plant.name,
                        style="max-width: 100%; max-height: 100%; object-fit: contain;"
                    ) }}


                </div>


            </div>
            <h3 style="margin: 10px 0 5px 0;">{{ item.plant.name }}</h3>
            <div style="display: inline-block; padding: 4px 12px; background: var(--link); color: white; border-radius: 20px; font-size: 0.85rem; font-weight: bold;">
                Level {{ item.level }}
            </div>
        </div>
        {% else %}
        <div style="grid-column: 1 / -1; text-align: center; padding: 60px; background: rgba(255,255,255,0.02); border-radius: 15px; border: 2px dashed rgba(255,255,255,0.1);">
            <p style="font-size: 1.2rem; color: var(--muted);">The garden is currently just soil. Gift {{ dog.name }} some seeds to start growing!</p>
        </div>
        {% endfor %}
    </div>


    {% if departed %}
        <div style="margin-top: 80px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 40px;">
            <h2 style="color: var(--muted); text-align: center; font-weight: 300; letter-spacing: 2px; text-transform: uppercase; font-size: 1rem;">The Hall of Fame</h2>

            <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-top: 20px;">
                {% for ghost in departed %}
                <div style="text-align: center; width: 100px; opacity: 0.6; transition: opacity 0.3s;"
                     onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">

                    {# Circular wrapper to force the video into a circle #}
                    <div style="width: 60px; height: 60px; border-radius: 50%; overflow: hidden; border: 1px solid #444; margin: 0 auto; background: #000;">
                        {{ render_media(
                            url_for('companion.dog_asset', breed=ghost.breed_type, expression='death'),
                            alt_text=ghost.name,
                            style="width: 100%; height: 100%; object-fit: cover; filter: grayscale(100%);",
                            is_video=True
                        ) }}
                    </div>

                    <p style="margin: 5px 0 0 0; font-size: 0.85rem; color: var(--muted);">{{ ghost.name }}</p>
                    <span style="font-size: 0.7rem; color: #666;">{{ ghost.died_at.strftime('%b %Y') }}</span>
                </div>
                {% endfor %}
            </div>
        </div>
    {% endif %}


    <div style="margin-top: 60px; text-align: center; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 40px;">
        <a href="{{ url_for('main.app_home') }}" class="btn secondary" style="margin-right: 15px;">Back to Curriculums</a>
        <form action="{{ url_for('companion.gift_seed') }}" method="POST" style="display: inline;">
             <button type="submit" class="btn primary">Gift Random Seed (1 AN)</button>
        </form>
    </div>
</div>

{% endblock %}
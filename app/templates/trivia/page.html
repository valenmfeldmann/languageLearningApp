{% extends "base.html" %}
{% block content %}

{% from "lessons/macros/typed.html" import render_typed %}

<style>
  /* --- Keep your existing .dark-field and .trivia-grid styles --- */
  .dark-field {
    background: rgba(255,255,255,0.06);
    color: rgba(255,255,255,0.92);
    border: 1px solid rgba(255,255,255,0.14);
    border-radius: 10px;
    padding: 10px 12px;
    outline: none;
  }
  .trivia-grid {
    display: grid;
    gap: 16px;
    margin-top: 20px;
    grid-template-columns: repeat(2, 1fr);
  }
  .choice-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 100%;
    aspect-ratio: 1 / 1;
    padding: 12px;
    border-radius: 16px;
    border: 1px solid rgba(255,255,255,0.25);
    background: rgba(255,255,255,0.08);
    color: white;
    cursor: pointer;
    overflow: hidden;
    transition: background 0.15s, transform 0.05s, opacity 0.2s;
  }
  .choice-btn img, .choice-btn video {
    width: 100% !important;
    height: 100% !important;
    max-height: 75% !important;
    object-fit: cover !important;
    display: block;
    border-radius: 10px;
    margin-bottom: 8px;
  }
</style>

<div style="max-width: 760px; margin: 0 auto; padding: 24px;">
  <h1>Trivia</h1>

  <form method="get" action="{{ url_for('appui.trivia_page') }}"
        style="display:flex; gap:8px; margin: 12px 0; flex-wrap:wrap; align-items:center;">
    <select name="subject" class="dark-field">
      <option value="">All subjects</option>
      {% for s in subjects %}
        <option value="{{ s.code }}" {% if subject_code == s.code %}selected{% endif %}>{{ s.name }}</option>
      {% endfor %}
    </select>
    <input name="q" value="{{ q or '' }}" placeholder="Search..." class="dark-field">
    <button class="btn" type="submit">Search</button>
  </form>

  <div id="trivia-card-container">
    {% if not block %}
      <p>No trivia question available.</p>
    {% else %}
      <div id="active-trivia-card" style="border: 1px solid rgba(255,255,255,0.15); border-radius: 16px; padding: 24px; background: rgba(0,0,0,0.45); box-shadow: 0 20px 40px rgba(0,0,0,0.35);">
        <div style="opacity: 0.65; font-size: 13px; margin-bottom: 14px;">Source: <b>{{ lesson.title }}</b></div>
        <div style="font-size: 22px; line-height: 1.4; font-weight: 500; color: #ffffff; margin-bottom: 20px;">
          {{ render_typed(block.payload_json.get("prompt", ""), lesson.id) }}
        </div>
        <form method="post" action="{{ url_for('appui.trivia_answer') }}" class="trivia-grid">
          <input type="hidden" name="block_id" value="{{ block.id }}">
          {% for c in block.payload_json.get("choices", []) %}
            <button type="button" class="choice-btn" name="choice_index" value="{{ loop.index0 }}">
              {{ render_typed(c, lesson.id) }}
            </button>
          {% endfor %}
        </form>
      </div>
    {% endif %}
  </div>

  <div id="trivia-buffer" style="display: none;"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
let bufferReady = false;

async function preloadNextQuestion() {
  bufferReady = false;
  const buffer = document.getElementById('trivia-buffer');
  try {
    const response = await fetch(window.location.href);
    const html = await response.text();
    const doc = new DOMParser().parseFromString(html, 'text/html');
    const nextCard = doc.getElementById('active-trivia-card');

    if (nextCard) {
      buffer.innerHTML = nextCard.innerHTML;

      // ACTIVE PRIMING: Find all images in the buffered question
      const images = buffer.querySelectorAll('img');
      const preloadPromises = Array.from(images).map(img => {
        return new Promise((resolve) => {
          const tempImg = new Image();
          tempImg.src = img.src;

          // .decode() is the secret for mobile â€” it forces the GPU
          // to process the image before we show it.
          tempImg.decode().then(() => {
            console.log("Mobile GPU primed image:", img.src);
            resolve();
          }).catch(() => {
            // Fallback for older browsers
            tempImg.onload = resolve;
            tempImg.onerror = resolve;
          });
        });
      });

      // Pre-prime the audio stream
      const audios = buffer.querySelectorAll('audio source');
      audios.forEach(src => {
        const a = new Audio();
        a.src = src.src;
        a.preload = "auto";
      });

      await Promise.all(preloadPromises);
      bufferReady = true;
      console.log("Question fully primed for mobile.");
    }
  } catch (err) { console.error("Preload fail", err); }
}



// page.html

// 1. SINGLETON INSTANTIATION (Outside the click handler)
// Creating this once prevents the mobile browser from re-loading the file every click.
const CHIME_EFFECT = new Audio("{{ url_for('static', filename='assets/sounds/chime.wav') }}");
CHIME_EFFECT.preload = "auto";
CHIME_EFFECT.volume = 0.35;

document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.choice-btn');
  if (!btn) return;

  e.preventDefault();

  // --- 2. SYNCHRONOUS WARM-UP ---
  // Mobile browsers require an "explicit touch" to enable audio.
  // We play and immediately pause to 'wake up' the audio channel for this session.
  CHIME_EFFECT.play().then(() => {
    CHIME_EFFECT.pause();
    CHIME_EFFECT.currentTime = 0;
  }).catch(() => {});

  // Prime existing trivia card audio (if any)
  const currentAudio = document.querySelector('#active-trivia-card audio');
  if (currentAudio) {
    currentAudio.pause();
    currentAudio.currentTime = 0;
  }

  // --- 3. LOCK UI ---
  const activeBtns = document.querySelectorAll('#active-trivia-card .choice-btn');
  activeBtns.forEach(b => {
    b.style.pointerEvents = 'none';
    b.style.opacity = '0.3';
  });

  const form = btn.closest('form');
  const formData = new FormData(form);
  formData.set('choice_index', btn.value);

  try {
    const response = await fetch(form.action, {
      method: 'POST',
      body: formData,
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    });
    const result = await response.json();

    // --- 4. INSTANT CELEBRATION ---
    if (result.is_correct) {

      // Haptic Feedback (Optional: gives a physical 'pop' on Android/iOS)
      if (window.navigator.vibrate) window.navigator.vibrate(40);

      if (typeof rewardFX === 'function') {
        rewardFX(result.payout);
      }
    } else {
      if (typeof damageFX === 'function') {
        damageFX();
        if (window.navigator.vibrate) window.navigator.vibrate([50, 50, 50]);
      }
    }

    // Update AN Balances
    ['header-an-balance', 'header-an-balance2'].forEach(id => {
      const el = document.getElementById(id);
      if (el && result.new_balance_an) el.textContent = result.new_balance_an;
    });

    // --- 5. THE SWAP ---
    setTimeout(() => {
      const activeCard = document.getElementById('active-trivia-card');
      const buffer = document.getElementById('trivia-buffer');

      document.querySelectorAll('.reward-overlay').forEach(el => el.remove());

      if (bufferReady && buffer.innerHTML.trim() !== "") {
        activeCard.innerHTML = buffer.innerHTML;
        buffer.innerHTML = "";

        // Autoplay fresh question audio
        const newAudio = activeCard.querySelector('audio');
        if (newAudio) {
          newAudio.play().catch(err => console.log("Autoplay blocked:", err));
        }

        preloadNextQuestion();
      } else {
        window.location.reload();
      }
    }, 800);

  } catch (err) {
    console.error("Submission Error:", err);
    window.location.reload();
  }
});

window.addEventListener('DOMContentLoaded', () => {
  preloadNextQuestion();
  const firstAudio = document.querySelector('#active-trivia-card audio');
  if (firstAudio) firstAudio.play().catch(() => {});
});
</script>
{% endblock %}